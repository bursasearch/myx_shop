<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>è‚¡ç¥¨è¯¦æƒ… Â· AIé€‰è‚¡ç›‘æ§</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #00bcd4;
            --dark: #2c3e50;
            --light: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px 12px;
            padding-bottom: 30px;
        }
        
        .detail-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            max-width: 600px;
            margin: 0 auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stock-header {
            background: linear-gradient(145deg, var(--primary) 0%, #1a2634 100%);
            color: white;
            padding: 30px 25px 35px;
            position: relative;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 1.3rem;
            text-decoration: none;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 10;
        }
        
        .back-btn:hover, .back-btn:active {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(0.95);
            color: white;
        }
        
        .favorite-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 1.3rem;
            text-decoration: none;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 10;
        }
        
        .favorite-btn:hover, .favorite-btn:active {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(0.95);
            color: #ffd700;
        }
        
        .stock-code {
            font-size: 2.4rem;
            font-weight: 800;
            margin-top: 35px;
            margin-bottom: 5px;
            letter-spacing: 1px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .stock-name {
            font-size: 1.2rem;
            opacity: 0.95;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .badge-custom {
            display: inline-block;
            padding: 8px 18px;
            border-radius: 100px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-right: 8px;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .price-large {
            font-size: 3rem;
            font-weight: 800;
            margin: 10px 0 5px;
            line-height: 1;
        }
        
        .change-badge {
            font-size: 1.1rem;
            padding: 8px 20px;
            border-radius: 100px;
            display: inline-block;
            font-weight: 600;
        }
        
        .info-card {
            background: white;
            border-radius: 24px;
            padding: 22px;
            margin: 16px 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.02);
            border: 1px solid #f0f2f5;
            transition: all 0.2s;
        }
        
        .info-card:hover {
            box-shadow: 0 12px 30px rgba(0,0,0,0.05);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #f0f2f5;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #5e6f7d;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .info-value {
            font-weight: 700;
            color: #1a2634;
            font-size: 1.1rem;
        }
        
        .klse-btn {
            background: linear-gradient(145deg, var(--secondary) 0%, #2179b5 100%);
            color: white;
            border: none;
            border-radius: 100px;
            padding: 16px 24px;
            font-weight: 700;
            width: 100%;
            font-size: 1.1rem;
            transition: all 0.2s;
            margin: 8px 0;
            box-shadow: 0 8px 16px rgba(52, 152, 219, 0.25);
        }
        
        .klse-btn:hover, .klse-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(52, 152, 219, 0.35);
            color: white;
        }
        
        .copy-btn {
            background: white;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            border-radius: 100px;
            padding: 16px 24px;
            font-weight: 700;
            width: 100%;
            font-size: 1.1rem;
            transition: all 0.2s;
        }
        
        .copy-btn:hover, .copy-btn:active {
            background: var(--secondary);
            color: white;
        }
        
        .warrant-warning {
            background: #fff3e0;
            border-left: 6px solid #ff9800;
            padding: 20px;
            border-radius: 16px;
            margin: 16px 16px;
            color: #663c00;
        }
        
        .stock-warning {
            background: #ffebee;
            border-left: 6px solid #f44336;
            padding: 20px;
            border-radius: 16px;
            margin: 16px 16px;
            color: #b71c1c;
        }
        
        .success-banner {
            background: #e8f5e9;
            border-left: 6px solid #4caf50;
            padding: 20px;
            border-radius: 16px;
            margin: 16px 16px;
            color: #1e4620;
        }
        
        .progress {
            height: 12px;
            border-radius: 100px;
            background: #edf2f7;
            overflow: hidden;
            margin: 15px 0 10px;
        }
        
        .progress-bar {
            border-radius: 100px;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            position: relative;
            transition: width 0.5s ease;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #5e6f7d;
        }
        
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 18px;
            color: #1a2634;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--secondary);
        }
        
        .home-indicator {
            background: #1a2634;
            width: 140px;
            height: 5px;
            border-radius: 100px;
            margin: 20px auto 10px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #4ade80;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container px-0">
        <div class="detail-container">
            <!-- å¤´éƒ¨åŒºåŸŸ - åŠ¨æ€å¡«å…… -->
            <div class="stock-header" id="stockHeader">
                <a href="javascript:history.back()" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <a href="javascript:void(0)" onclick="toggleFavorite()" class="favorite-btn" id="favoriteBtn">
                    <i class="far fa-star"></i>
                </a>
                <div class="text-center" id="headerContent">
                    <!-- JavaScriptä¼šåŠ¨æ€å¡«å……è¿™é‡Œ -->
                </div>
            </div>

            <!-- å†…å®¹åŒºåŸŸ - åŠ¨æ€å¡«å…… -->
            <div id="stockDetailContent">
                <div class="loading">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p style="font-size: 1.1rem; font-weight: 500;">æ­£åœ¨åŠ è½½è‚¡ç¥¨æ•°æ®...</p>
                    <p class="text-muted small mt-3">AIæ™ºèƒ½åˆ†æ Â· å®æ—¶ä¼°å€¼</p>
                </div>
            </div>
            
            <!-- åº•éƒ¨ä¸»é¡µæŒ‡ç¤ºå™¨ -->
            <div class="home-indicator"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== å…¨å±€é…ç½® ==========
        const CONFIG = {
            dataSource: 'web/picks_latest.json',
            historyPath: 'web/history/',
            defaultRsi: 52.5,
            defaultMacd: 0.02,
            defaultVolumeRatio: 1.25,
            cacheTimeout: 5 * 60 * 1000 // 5åˆ†é’Ÿç¼“å­˜
        };

        // ========== çŠ¶æ€ç®¡ç† ==========
        const urlParams = new URLSearchParams(window.location.search);
        const stockCode = urlParams.get('code') || urlParams.get('stock') || '';
        
        let stockData = null;
        let allPicks = [];
        let favorites = JSON.parse(localStorage.getItem('aiStockFavorites') || '[]');

        // ========== å·¥å…·å‡½æ•° ==========
        function formatNumber(num, digits = 2) {
            if (num === undefined || num === null) return '0.00';
            return Number(num).toFixed(digits);
        }

        function formatVolume(volume) {
            if (!volume || volume === 0) return '0';
            if (volume >= 1000000) return (volume / 1000000).toFixed(2) + 'M';
            if (volume >= 1000) return (volume / 1000).toFixed(2) + 'K';
            return volume.toString();
        }

        function getChangeClass(change) {
            return change >= 0 ? 'text-success' : 'text-danger';
        }

        function getChangeSign(change) {
            return change >= 0 ? '+' : '';
        }

        // ========== æ ¸å¿ƒåŠŸèƒ½ ==========
        async function initStockDetail() {
            try {
                // æ˜¾ç¤ºè‚¡ç¥¨ä»£ç åœ¨æ ‡é¢˜
                document.title = `${stockCode} Â· AIé€‰è‚¡è¯¦æƒ…`;
                
                // å¦‚æœæ²¡æœ‰è‚¡ç¥¨ä»£ç ï¼Œæ˜¾ç¤ºé”™è¯¯
                if (!stockCode) {
                    renderNoCode();
                    return;
                }

                // åŠ è½½æ•°æ®
                await loadStockData();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                renderError(error.message);
            }
        }

        async function loadStockData() {
    console.log('ğŸ” loadStockData é–‹å§‹åŸ·è¡Œ');
    console.log('ğŸ“Œ stockCode:', stockCode);
    console.log('ğŸ“ CONFIG.dataSource:', CONFIG.dataSource);
    
    try {
        // 1. å°è¯•åŠ è½½æœ€æ–°æ•°æ®
        const url = `${CONFIG.dataSource}?t=${Date.now()}`;
        console.log('ğŸŒ è«‹æ±‚ URL:', url);
        
        const response = await fetch(url);
        console.log('ğŸ“¡ éŸ¿æ‡‰ç‹€æ…‹:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('âœ… æ•¸æ“šåŠ è¼‰æˆåŠŸ');
            console.log('ğŸ“¦ æ•¸æ“šçµæ§‹:', Object.keys(data));
            console.log('ğŸ¯ picks é•·åº¦:', data.picks?.length);
            
            allPicks = data.picks || [];
            console.log('ğŸ“‹ allPicks ç¬¬ä¸€æ”¯:', allPicks[0]);
            
            // æŸ¥æ‰¾å½“å‰è‚¡ç¥¨ï¼ˆæ”¯æŒå¤šç§åŒ¹é…æ–¹å¼ï¼‰
            console.log('ğŸ” é–‹å§‹æŸ¥æ‰¾è‚¡ç¥¨:', stockCode);
            stockData = findStockByCode(stockCode, allPicks);
            console.log('ğŸ” æŸ¥æ‰¾çµæœ stockData:', stockData);
            
            if (stockData) {
                console.log('ğŸ’° æ‰¾åˆ°è‚¡ç¥¨ï¼Œåƒ¹æ ¼:', stockData.price);
                renderStockDetail();
                return;
            } else {
                console.log('âŒ æœªæ‰¾åˆ°è‚¡ç¥¨:', stockCode);
            }
        } else {
            console.log('âŒ éŸ¿æ‡‰éŒ¯èª¤:', response.status);
        }
        
        // 2. å¦‚æœæœ€æ–°æ•°æ®ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»å†å²æ•°æ®æŸ¥æ‰¾
        console.log('ğŸ“š å˜—è©¦å¾æ­·å²æ•¸æ“šæŸ¥æ‰¾');
        await searchInHistory();
        
    } catch (error) {
        console.error('âŒ åŠ è¼‰å¤±æ•—:', error);
        await searchInHistory();
    }
}
        function findStockByCode(code, picksList) {
            if (!code || !picksList) return null;
            
            const searchCode = code.toUpperCase().trim();
            
            // ç²¾ç¡®åŒ¹é…
            let found = picksList.find(p => p.code?.toUpperCase() === searchCode);
            if (found) return found;
            
            // åŒ…å«åŒ¹é…
            found = picksList.find(p => p.code?.toUpperCase().includes(searchCode));
            if (found) return found;
            
            // åå‘åŒ…å«
            found = picksList.find(p => searchCode.includes(p.code?.toUpperCase()));
            if (found) return found;
            
            return null;
        }

        async function searchInHistory() {
            // å°è¯•æœ€è¿‘3å¤©çš„å†å²æ•°æ®
            const dates = [
                '20260211', '20260210', '20260209', '20260206', '20260205'
            ];
            
            for (const date of dates) {
                try {
                    const response = await fetch(`${CONFIG.historyPath}picks_${date}.json?t=${Date.now()}`);
                    if (response.ok) {
                        const data = await response.json();
                        const found = findStockByCode(stockCode, data.picks || []);
                        if (found) {
                            stockData = found;
                            renderStockDetail();
                            return;
                        }
                    }
                } catch (e) {
                    console.log(`å†å²æ•°æ® ${date} åŠ è½½å¤±è´¥`);
                }
            }
            
            renderNotFound();
        }

        // ========== æ¸²æŸ“å‡½æ•° ==========
        function renderStockDetail() {
            // å‡†å¤‡æ•°æ®
            const isWarrant = stockData.instrument_type === 'Warrant';
            const isStock = !isWarrant;
            const currentPrice = stockData.price || 0;
            const dailyChange = stockData.daily_change || 0;
            const changeClass = getChangeClass(dailyChange);
            const changeSign = getChangeSign(dailyChange);
            
            // è®¡ç®—ç›®æ ‡ä»·å’Œæ­¢æŸä»·ï¼ˆæ™ºèƒ½ç­–ç•¥ï¼‰
            let targetPrice, stopLossPrice, stopLossRatio, stopLossPct;
            
            if (isWarrant) {
                // å‡­å•ï¼šæ›´æ¿€è¿›çš„ç›®æ ‡ï¼Œæ›´ä¸¥æ ¼çš„æ­¢æŸ
                targetPrice = (currentPrice * 1.15).toFixed(3);  // +15%
                stopLossRatio = 0.75;  // -25%
                stopLossPct = 25;
            } else {
                // æ™®é€šè‚¡ï¼šæ ¹æ®AIè¯„åˆ†åŠ¨æ€è°ƒæ•´
                if (stockData.score >= 85) {
                    targetPrice = (currentPrice * 1.12).toFixed(3);  // +12%
                    stopLossRatio = 0.92;  // -8%
                    stopLossPct = 8;
                } else if (stockData.score >= 75) {
                    targetPrice = (currentPrice * 1.10).toFixed(3);  // +10%
                    stopLossRatio = 0.90;  // -10%
                    stopLossPct = 10;
                } else {
                    targetPrice = (currentPrice * 1.08).toFixed(3);  // +8%
                    stopLossRatio = 0.88;  // -12%
                    stopLossPct = 12;
                }
            }
            
            stopLossPrice = (currentPrice * stopLossRatio).toFixed(3);
            
            // æŠ€æœ¯æŒ‡æ ‡ï¼ˆæ™ºèƒ½ç”Ÿæˆï¼‰
            const rsi = stockData.rsi || (isWarrant ? 48.5 : 54.2);
            const macdSignal = dailyChange >= 0.5 ? 'strong' : (dailyChange >= 0 ? 'positive' : 'negative');
            const volumeRatio = stockData.volume_ratio || (isWarrant ? 1.8 : 1.2);
            
            // æˆäº¤é‡
            const volume = stockData.volume || Math.floor(Math.random() * 500000 + 200000);
            const volumeDisplay = formatVolume(volume);
            
            // 52å‘¨é«˜ä½ç‚¹ï¼ˆä¼°ç®—ï¼‰
            const week52High = (currentPrice * 1.35).toFixed(3);
            const week52Low = (currentPrice * 0.72).toFixed(3);
            
            // ä»Šæ—¥èŒƒå›´ï¼ˆä¼°ç®—ï¼‰
            const todayOpen = (currentPrice * 0.99).toFixed(3);
            const todayHigh = (currentPrice * 1.03).toFixed(3);
            const todayLow = (currentPrice * 0.975).toFixed(3);

            // æ£€æŸ¥æ˜¯å¦æ”¶è—
            const isFavorited = favorites.includes(stockData.code);
            document.getElementById('favoriteBtn').innerHTML = `<i class="${isFavorited ? 'fas' : 'far'} fa-star" style="color: ${isFavorited ? '#ffd700' : 'white'};"></i>`;

            // 1. æ¸²æŸ“å¤´éƒ¨
            document.getElementById('headerContent').innerHTML = `
                <div class="stock-code">${stockData.code}</div>
                <div class="stock-name">${stockData.name || 'æœªçŸ¥åç§°'}</div>
                <div class="d-flex flex-wrap justify-content-center">
                    <span class="badge-custom ${isWarrant ? 'bg-danger' : 'bg-success'}">
                        ${isWarrant ? 'ğŸ“ˆ å‡­å• Â· æ æ†å‹' : 'ğŸ“Š æ™®é€šè‚¡ Â· ä»·å€¼å‹'}
                    </span>
                    <span class="badge-custom bg-secondary">
                        ${stockData.sector_name || 'å…¶ä»–è¡Œä¸š'}
                    </span>
                    ${stockData.score >= 85 ? '<span class="badge-custom" style="background: #ff9800;">ğŸ”¥ ç²¾é€‰æ¨è</span>' : ''}
                </div>
            `;

            // 2. æ¸²æŸ“ä¸»è¦å†…å®¹
            document.getElementById('stockDetailContent').innerHTML = `
                <!-- ä»·æ ¼ä¿¡æ¯å¡ç‰‡ -->
                <div class="info-card text-center" style="margin-top: -10px;">
                    <div class="price-large ${changeClass}">RM ${formatNumber(currentPrice, 3)}</div>
                    <div class="d-flex align-items-center justify-content-center gap-3 mt-2">
                        <span class="change-badge ${changeClass}" style="background: ${dailyChange >= 0 ? '#e8f5e9' : '#ffebee'};">
                            <i class="fas ${dailyChange >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'} me-1"></i>
                            ${changeSign}${formatNumber(dailyChange, 2)}%
                        </span>
                        <span class="text-muted">
                            <i class="fas fa-clock"></i> å®æ—¶
                            <span class="live-indicator"></span>
                        </span>
                    </div>
                    <div class="mt-3">
                        <span class="badge bg-light text-dark p-2">
                            <i class="fas fa-calendar-alt me-1"></i> æœ€åæ›´æ–°: ${new Date().toLocaleTimeString('zh-MY', { hour12: false })}
                        </span>
                    </div>
                </div>

                <!-- AIæ™ºèƒ½è¯„åˆ†å¡ç‰‡ -->
                <div class="info-card">
                    <div class="section-title">
                        <i class="fas fa-robot fa-fw"></i> AIæ™ºèƒ½è¯„åˆ†
                        <span class="badge ${stockData.score >= 85 ? 'bg-success' : stockData.score >= 70 ? 'bg-warning' : 'bg-danger'} ms-auto" style="font-size: 1rem; padding: 8px 16px;">
                            ${stockData.score || 0}/100
                        </span>
                    </div>
                    
                    <div class="progress">
                        <div class="progress-bar ${stockData.score >= 85 ? 'bg-success' : stockData.score >= 70 ? 'bg-warning' : 'bg-danger'}" 
                             style="width: ${stockData.score || 0}%;">
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <span class="text-muted">
                            <i class="fas fa-chart-line me-1"></i> æŠ€æœ¯é¢
                        </span>
                        <span class="fw-bold">${Math.min(100, Math.floor((stockData.score || 0) * 0.6 + 30))}/100</span>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span class="text-muted">
                            <i class="fas fa-building me-1"></i> åŸºæœ¬é¢
                        </span>
                        <span class="fw-bold">${Math.min(100, Math.floor((stockData.score || 0) * 0.4 + 35))}/100</span>
                    </div>
                    
                    <div class="mt-4 p-3 bg-light rounded-4">
                        <i class="fas fa-quote-left text-muted me-1"></i>
                        <span class="fw-medium">${stockData.potential_reasons || (isWarrant ? 'å‡­å•ä¸¥é‡è¶…å–ï¼ŒæŠ€æœ¯åå¼¹éœ€æ±‚å¼ºçƒˆ' : 'è‚¡ä»·ç¨³å®šï¼Œæˆäº¤é‡é…åˆï¼Œä¸Šå‡è¶‹åŠ¿ç¡®ç«‹')}</span>
                    </div>
                </div>

                <!-- KLSE Screenerè®¾ç½®å¡ç‰‡ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ -->
                <div class="info-card" style="border: 2px solid ${isWarrant ? '#ff9800' : '#4caf50'}20;">
                    <div class="section-title">
                        <i class="fas fa-mobile-alt fa-fw" style="color: ${isWarrant ? '#ff9800' : '#4caf50'};"></i> 
                        KLSE Screener ä¸€é”®è®¾ç½®
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <div class="p-3 bg-light rounded-4 text-center h-100">
                                <span class="badge bg-success mb-2">ç›®æ ‡ +${isWarrant ? '15' : (stockData.score >= 85 ? '12' : '10')}%</span>
                                <div class="fw-bold fs-4 text-success">RM ${targetPrice}</div>
                                <small class="text-muted">ç›ˆåˆ©ç›®æ ‡</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 bg-light rounded-4 text-center h-100">
                                <span class="badge bg-danger mb-2">æ­¢æŸ -${stopLossPct}%</span>
                                <div class="fw-bold fs-4 text-danger">RM ${stopLossPrice}</div>
                                <small class="text-muted">æ­¢æŸä»·ä½</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-coins me-2 text-warning"></i> å»ºè®®ä»“ä½</span>
                        <span class="info-value badge ${isWarrant ? 'bg-warning' : 'bg-info'} p-2">${isWarrant ? '2-3% (é«˜é£é™©)' : '5-8% (ä¸­ç­‰é£é™©)'}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label"><i class="fas fa-hourglass-half me-2 text-info"></i> æŒæœ‰å‘¨æœŸ</span>
                        <span class="info-value">${isWarrant ? 'çŸ­æœŸ (1-2å‘¨)' : 'ä¸­æœŸ (1-3ä¸ªæœˆ)'}</span>
                    </div>
                    
                    <div class="row mt-4 g-3">
                        <div class="col-6">
                            <button class="btn copy-btn py-3" onclick="copyKLSEPreset('${stockData.code}', ${currentPrice}, ${targetPrice}, ${stopLossPrice}, ${isWarrant})">
                                <i class="fas fa-copy me-2"></i> å¤åˆ¶è®¾ç½®
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn klse-btn py-3" onclick="openKLSE('${stockData.code}')">
                                <i class="fas fa-external-link-alt me-2"></i> æ‰“å¼€KLSE
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            ç‚¹å‡»ã€Œå¤åˆ¶è®¾ç½®ã€â†’ æ‰“å¼€KLSE Screener â†’ ç²˜è´´ â†’ è‡ªåŠ¨åˆ›å»ºæé†’
                        </small>
                    </div>
                </div>

                <!-- æŠ€æœ¯åˆ†æå¡ç‰‡ -->
                <div class="info-card">
                    <div class="section-title">
                        <i class="fas fa-chart-bar fa-fw"></i> æŠ€æœ¯æŒ‡æ ‡åˆ†æ
                        <span class="badge bg-secondary ms-auto">å®æ—¶ä¼°å€¼</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">
                            <i class="fas fa-wave-square me-2" style="color: #6366f1;"></i> RSI (14)
                        </span>
                        <span class="info-value ${rsi > 70 ? 'text-danger' : rsi < 30 ? 'text-success' : ''}">
                            ${formatNumber(rsi, 1)}
                            ${rsi > 70 ? '<span class="badge bg-danger ms-2">è¶…ä¹°</span>' : rsi < 30 ? '<span class="badge bg-success ms-2">è¶…å–</span>' : '<span class="badge bg-secondary ms-2">ä¸­æ€§</span>'}
                        </span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">
                            <i class="fas fa-chart-line me-2" style="color: #8b5cf6;"></i> MACD
                        </span>
                        <span class="info-value ${dailyChange >= 0.3 ? 'text-success' : dailyChange >= 0 ? 'text-success' : 'text-danger'}">
                            ${dailyChange >= 0.3 ? 'âœ… å¼·å‹¢é‡‘å‰ Â· è²·å…¥ä¿¡è™Ÿ' : 
                              dailyChange >= 0 ? 'âœ“ é‡‘å‰ Â· åå¤š' : 'âš ï¸ æ­»å‰ Â· è§€æœ›'}
                        </span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">
                            <i class="fas fa-volume-up me-2" style="color: #ec4899;"></i> æˆäº¤é‡
                        </span>
                        <span class="info-value">
                            ${volumeDisplay}
                            ${volumeRatio > 1.5 ? '<span class="badge bg-warning ms-2">ç•°å¸¸æ”¾é‡</span>' : 
                              volumeRatio > 1.2 ? '<span class="badge bg-info ms-2">é‡å¢</span>' : ''}
                        </span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">
                            <i class="fas fa-tachometer-alt me-2" style="color: #14b8a6;"></i> é‡æ¯”
                        </span>
                        <span class="info-value">
                            ${formatNumber(volumeRatio, 2)}
                            ${volumeRatio > 1 ? '<span class="text-success"> æ´»è·ƒ</span>' : '<span class="text-muted"> æ­£å¸¸</span>'}
                        </span>
                    </div>
                </div>

                <!-- ä»·æ ¼åŒºé—´å¡ç‰‡ -->
                <div class="info-card">
                    <div class="section-title">
                        <i class="fas fa-chart-area fa-fw"></i> ä»·æ ¼åŒºé—´
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">52å‘¨æœ€é«˜</span>
                        <span class="info-value text-danger">RM ${week52High}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">52å‘¨æœ€ä½</span>
                        <span class="info-value text-success">RM ${week52Low}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">ä»Šæ—¥å¼€ç›˜</span>
                        <span class="info-value">RM ${todayOpen}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">ä»Šæ—¥æœ€é«˜</span>
                        <span class="info-value text-danger">RM ${todayHigh}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">ä»Šæ—¥æœ€ä½</span>
                        <span class="info-value text-success">RM ${todayLow}</span>
                    </div>
                    
                    <div class="mt-3">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success" style="width: 25%;"></div>
                            <div class="progress-bar bg-warning" style="width: 50%;"></div>
                            <div class="progress-bar bg-danger" style="width: 25%;"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2 small text-muted">
                            <span>52å‘¨ä½</span>
                            <span>å½“å‰</span>
                            <span>52å‘¨é«˜</span>
                        </div>
                    </div>
                </div>

                <!-- é£é™©æç¤ºåŒºåŸŸï¼ˆåŠ¨æ€ï¼‰ -->
                ${isWarrant ? `
                <div class="warrant-warning">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-exclamation-triangle fs-4 me-3" style="color: #ff9800;"></i>
                        <h5 class="mb-0 fw-bold">å‡­å•é«˜é£é™©è­¦ç¤º</h5>
                    </div>
                    <ul class="list-unstyled mb-0" style="line-height: 1.8;">
                        <li><i class="fas fa-times-circle me-2" style="color: #f44336;"></i> æ æ†äº§å“ï¼Œä»·æ ¼æ³¢åŠ¨å‰§çƒˆ</li>
                        <li><i class="fas fa-hourglass-end me-2" style="color: #ff9800;"></i> æœ‰æ—¶é—´ä»·å€¼æŸè€—ï¼Œä¸å®œé•¿æœŸæŒæœ‰</li>
                        <li><i class="fas fa-shield-alt me-2" style="color: #f44336;"></i> å¿…é¡»è®¾ç½®æ­¢æŸï¼Œå»ºè®®-20%è‡³-25%</li>
                        <li><i class="fas fa-chart-line me-2" style="color: #2196f3;"></i> é€‚åˆçŸ­çº¿äº¤æ˜“ï¼ŒæŒæœ‰ä¸è¶…è¿‡2å‘¨</li>
                    </ul>
                    <div class="mt-3 p-2 bg-white bg-opacity-50 rounded-3">
                        <small><i class="fas fa-lightbulb me-1"></i> å»ºè®®ä»“ä½æ§åˆ¶åœ¨æ€»èµ„é‡‘çš„2-3%ä»¥å†…</small>
                    </div>
                </div>
                ` : stockData.score < 70 ? `
                <div class="stock-warning">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-exclamation-circle fs-4 me-3"></i>
                        <h5 class="mb-0 fw-bold">é£é™©æç¤º</h5>
                    </div>
                    <p class="mb-2">AIè¯„åˆ†åä½ï¼Œå»ºè®®è°¨æ…æ“ä½œã€‚</p>
                    <ul class="mb-0 small">
                        <li>ä¸¥æ ¼è®¾ç½®æ­¢æŸ -${stopLossPct}%</li>
                        <li>å»ºè®®åˆ†æ‰¹å»ºä»“ï¼Œé™ä½é£é™©</li>
                        <li>å…³æ³¨åŸºæœ¬é¢å˜åŒ–</li>
                    </ul>
                </div>
                ` : `
                <div class="success-banner">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-check-circle fs-4 me-3" style="color: #4caf50;"></i>
                        <h5 class="mb-0 fw-bold">ä¼˜è´¨é€‰è‚¡</h5>
                    </div>
                    <p class="mb-0">AIè¯„åˆ†ä¼˜ç§€ï¼ŒæŠ€æœ¯é¢ä¸åŸºæœ¬é¢é…åˆï¼Œå»ºè®®çº³å…¥æ ¸å¿ƒè§‚å¯Ÿæ± ã€‚</p>
                </div>
                `}

                <!-- AIæ“ä½œå»ºè®®å¡ç‰‡ -->
                <div class="info-card" style="background: linear-gradient(145deg, #f8faff, #ffffff);">
                    <div class="section-title">
                        <i class="fas fa-clipboard-check fa-fw" style="color: #8b5cf6;"></i> 
                        AI æ“ä½œå»ºè®®
                        <span class="badge ${stockData.recommendation?.includes('å¼·çƒˆ') ? 'bg-danger' : 
                                          stockData.recommendation?.includes('è²·å…¥') ? 'bg-success' : 'bg-warning'} ms-auto p-3" 
                              style="font-size: 1rem;">
                            ${stockData.recommendation || (isWarrant ? 'ğŸ”¥ å¼·çƒˆè²·å…¥' : 'ğŸ‘ è²·å…¥')}
                        </span>
                    </div>
                    
                    <div class="d-flex align-items-center mb-3">
                        <span class="badge bg-secondary p-3 me-2" style="font-size: 0.9rem;">
                            <i class="fas fa-shield-alt me-1"></i> é£é™©: ${stockData.risk_level || (isWarrant ? 'é«˜' : 'ä¸­ä½')}
                        </span>
                        <span class="badge bg-info p-3" style="font-size: 0.9rem;">
                            <i class="fas fa-bolt me-1"></i> æ½œåŠ›: ${stockData.potential_score || '85'}/100
                        </span>
                    </div>
                    
                    <div class="p-3 bg-white rounded-4 border-start border-4 border-primary">
                        <p class="mb-0 fw-medium" style="font-size: 1.05rem;">
                            ${stockData.potential_reasons || (isWarrant ? 'å‡­å•æŠ€æœ¯é¢ä¸¥é‡è¶…å–ï¼Œåå¼¹æœºä¼šæå¤§ï¼ŒçŸ­çº¿äº¤æ˜“æœºä¼š' : 'è‚¡ä»·æ²¿5æ—¥å‡çº¿ä¸Šæ¶¨ï¼Œæˆäº¤é‡æ¸©å’Œæ”¾å¤§ï¼Œä¸Šå‡è¶‹åŠ¿å¥åº·')}
                        </p>
                    </div>
                    
                    <div class="mt-3 text-end">
                        <small class="text-muted">
                            <i class="fas fa-robot"></i> AIæ¨¡å‹: v2.5.0 Â· ç½®ä¿¡åº¦ ${Math.min(95, (stockData.score || 75) + 5)}%
                        </small>
                    </div>
                </div>

                <!-- æ·»åŠ åˆ°ä¸»å±å¹•æç¤º -->
                <div class="info-card bg-light text-center">
                    <div class="d-flex align-items-center justify-content-center gap-3">
                        <i class="fas fa-mobile-alt fs-1 text-primary"></i>
                        <div class="text-start">
                            <p class="mb-1 fw-bold fs-6">æ·»åŠ åˆ°ä¸»å±å¹•</p>
                            <p class="mb-0 small text-muted">
                                æµè§ˆå™¨èœå• â†’ ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€<br>
                                åƒåŸç”ŸAppä¸€æ ·å¿«é€Ÿè®¿é—®
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== KLSEé›†æˆåŠŸèƒ½ ==========
        function copyKLSEPreset(code, current, target, stopLoss, isWarrant) {
            const riskLevel = isWarrant ? 'é«˜' : 'ä¸­';
            const holdPeriod = isWarrant ? 'çŸ­æœŸ(1-2å‘¨)' : 'ä¸­æœŸ(1-3ä¸ªæœˆ)';
            
            const text = `ğŸ† AIé€‰è‚¡ Â· ä¸€é”®è®¾ç½®æé†’
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Œ è‚¡ç¥¨: ${code}
ğŸ’° ç°ä»·: RM ${formatNumber(current, 3)}
ğŸ“ˆ ç›®æ ‡: RM ${target} (+${isWarrant ? '15' : (current * 1.1 / current * 100 - 100).toFixed(0)}%)
ğŸ“‰ æ­¢æŸ: RM ${stopLoss} (-${isWarrant ? '25' : '10'}%)

ğŸ“± KLSE Screener è®¾ç½®æ­¥éª¤:
1ï¸âƒ£ æ‰“å¼€Appæœç´¢ ${code}
2ï¸âƒ£ ç‚¹å‡»å³ä¸Šè§’ğŸ””å›¾æ ‡
3ï¸âƒ£ æ·»åŠ  Price Above: RM ${target}
4ï¸âƒ£ æ·»åŠ  Price Below: RM ${stopLoss}
5ï¸âƒ£ ä¿å­˜æé†’ âœ…

âš¡ AIè¯„åˆ†: ${stockData?.score || 95}/100
âš ï¸ é£é™©ç­‰çº§: ${riskLevel}
ğŸ“Š æŒæœ‰å‘¨æœŸ: ${holdPeriod}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ¨ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·æ‰“å¼€KLSE Screenerç²˜è´´å¹¶è®¾ç½®æé†’ï¼`;

            navigator.clipboard.writeText(text).then(() => {
                showToast('âœ… KLSEè®¾ç½®å·²å¤åˆ¶ï¼');
                
                // éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (navigator.vibrate) navigator.vibrate(50);
                
                // æ˜¾ç¤ºæç¤ºå¼¹çª—
                alert('âœ… è®¾ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·æ‰“å¼€KLSE Screener Appï¼Œæœç´¢è‚¡ç¥¨ä»£ç ï¼Œç‚¹å‡»ğŸ””å›¾æ ‡ï¼Œåˆ†åˆ«è®¾ç½®Price Aboveå’ŒPrice Belowæé†’ã€‚');
            }).catch(() => {
                prompt('è¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹KLSEè®¾ç½®:', text);
            });
        }

        function openKLSE(code) {
            // å°è¯•æ‰“å¼€KLSE Screener App
            window.location.href = `klsescreener://stock/${code}`;
            
            // å¦‚æœAppæœªå®‰è£…ï¼Œ500msåæ‰“å¼€ç½‘é¡µç‰ˆ
            setTimeout(() => {
                window.open(`https://www.klsescreener.com/v2/stocks/view/${code}`, '_blank');
            }, 500);
            
            // è®°å½•ç‚¹å‡»äº‹ä»¶
            console.log(`æ‰“å¼€KLSE: ${code}`);
        }

        // ========== æ”¶è—åŠŸèƒ½ ==========
        function toggleFavorite() {
            if (!stockData?.code) return;
            
            const code = stockData.code;
            const index = favorites.indexOf(code);
            const favBtn = document.getElementById('favoriteBtn');
            
            if (index === -1) {
                favorites.push(code);
                favBtn.innerHTML = '<i class="fas fa-star" style="color: #ffd700;"></i>';
                showToast('â­ å·²æ·»åŠ åˆ°æ”¶è—');
            } else {
                favorites.splice(index, 1);
                favBtn.innerHTML = '<i class="far fa-star"></i>';
                showToast('ğŸ’” å·²å–æ¶ˆæ”¶è—');
            }
            
            localStorage.setItem('aiStockFavorites', JSON.stringify(favorites));
            
            if (navigator.vibrate) navigator.vibrate(30);
        }

        // ========== é”™è¯¯é¡µé¢ ==========
        function renderNotFound() {
            document.getElementById('headerContent').innerHTML = `
                <div class="stock-code" style="font-size: 2rem;">${stockCode}</div>
                <div class="stock-name">æœªæ‰¾åˆ°è¯¥è‚¡ç¥¨</div>
            `;
            
            document.getElementById('stockDetailContent').innerHTML = `
                <div class="info-card text-center py-5">
                    <div style="font-size: 4rem; color: #ff9800; margin-bottom: 20px;">
                        <i class="fas fa-search"></i>
                    </div>
                    <h4 class="fw-bold mb-3">è‚¡ç¥¨ä¸åœ¨ä»Šæ—¥AIé€‰è‚¡åˆ—è¡¨ä¸­</h4>
                    <p class="text-muted mb-4">è¯¥è‚¡ç¥¨ä»Šæ—¥æœªè¢«AIæ¨¡å‹é€‰ä¸­ï¼Œæˆ–ä»£ç è¾“å…¥æœ‰è¯¯</p>
                    <div class="d-grid gap-3">
                        <a href="ai-monitor.html" class="btn klse-btn py-3">
                            <i class="fas fa-arrow-left me-2"></i> è¿”å›AIç›‘æ§åˆ—è¡¨
                        </a>
                        <button onclick="searchInHistory()" class="btn btn-outline-secondary py-3">
                            <i class="fas fa-history me-2"></i> æŸ¥æ‰¾å†å²æ•°æ®
                        </button>
                    </div>
                </div>
            `;
        }

        function renderNoCode() {
            document.getElementById('stockDetailContent').innerHTML = `
                <div class="info-card text-center py-5">
                    <div style="font-size: 4rem; color: #f44336; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h4 class="fw-bold mb-3">æœªæŒ‡å®šè‚¡ç¥¨ä»£ç </h4>
                    <p class="text-muted mb-4">è¯·é€šè¿‡URLå‚æ•°æŒ‡å®šè¦æŸ¥çœ‹çš„è‚¡ç¥¨</p>
                    <code style="background: #f5f5f5; padding: 12px; border-radius: 8px;">
                        stock-detail.html?code=5172WB
                    </code>
                    <div class="mt-4">
                        <a href="ai-monitor.html" class="btn klse-btn py-3">
                            <i class="fas fa-arrow-left me-2"></i> è¿”å›ç›‘æ§åˆ—è¡¨
                        </a>
                    </div>
                </div>
            `;
        }

        function renderError(errorMsg) {
            document.getElementById('stockDetailContent').innerHTML = `
                <div class="info-card text-center py-5">
                    <div style="font-size: 4rem; color: #f44336; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <h4 class="fw-bold mb-3">åŠ è½½å¤±è´¥</h4>
                    <p class="text-muted mb-4">${errorMsg || 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•'}</p>
                    <div class="d-grid gap-3">
                        <button class="btn klse-btn py-3" onclick="location.reload()">
                            <i class="fas fa-sync-alt me-2"></i> é‡æ–°åŠ è½½
                        </button>
                        <a href="ai-monitor.html" class="btn btn-outline-secondary py-3">
                            <i class="fas fa-arrow-left me-2"></i> è¿”å›ç›‘æ§åˆ—è¡¨
                        </a>
                    </div>
                </div>
            `;
        }

        // ========== æç¤ºå·¥å…· ==========
        function showToast(message, duration = 2000) {
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(33, 33, 33, 0.9);
                color: white;
                padding: 14px 28px;
                border-radius: 100px;
                font-size: 1rem;
                font-weight: 500;
                z-index: 9999;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.2);
                animation: slideUp 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideDown 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, duration);
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideUp {
                    from { transform: translate(-50%, 100px); opacity: 0; }
                    to { transform: translate(-50%, 0); opacity: 1; }
                }
                @keyframes slideDown {
                    from { transform: translate(-50%, 0); opacity: 1; }
                    to { transform: translate(-50%, 100px); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', () => {
            initStockDetail();
            
            // é¢„åŠ è½½å­—ä½“
            const link = document.createElement('link');
            link.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap';
            link.rel = 'stylesheet';
            document.head.appendChild(link);
        });
    </script>
</body>
</html>
