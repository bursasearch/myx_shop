<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>AIé€‰è‚¡ç›‘æ§ä»ªè¡¨æ¿ - MyX Shop</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .dashboard-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
            color: white;
            padding: 2rem;
            border-bottom: 5px solid var(--secondary);
        }
        .stock-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
            cursor: pointer;
        }
        .stock-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }
        .stock-card.warrant {
            border-left: 5px solid var(--danger);
        }
        .stock-card.stock {
            border-left: 5px solid var(--success);
        }
        .price-change.positive {
            color: var(--success);
            font-weight: bold;
        }
        .price-change.negative {
            color: var(--danger);
            font-weight: bold;
        }
        .progress-bar-custom {
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        .alert-box {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .klse-action-btn {
            background: linear-gradient(135deg, var(--secondary) 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .klse-action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        .refresh-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: var(--primary);">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-chart-line"></i> MyX Shop AI Trader
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="index.html"><i class="fas fa-home"></i> é¦–é¡µ</a>
                <a class="nav-link active" href="ai-monitor.html"><i class="fas fa-robot"></i> AIé€‰è‚¡ç›‘æ§</a>
                <a class="nav-link" href="klse-guide.html"><i class="fas fa-mobile-alt"></i> KLSEæŒ‡å—</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="dashboard-container">
            <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1><i class="fas fa-robot"></i> AIé€‰è‚¡ç›‘æ§ä»ªè¡¨æ¿</h1>
                        <p class="mb-0">å®æ—¶è¿½è¸ªAIæ¨èè‚¡ç¥¨è¡¨ç°ä¸KLSEéªŒè¯çŠ¶æ€</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="alert alert-info d-inline-block">
                            <i class="fas fa-sync-alt refresh-badge"></i>
                            æœ€åæ›´æ–°: <span id="lastUpdateTime">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡æ‘˜è¦ -->
            <div class="row p-4">
                <div class="col-md-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h3><i class="fas fa-stock text-success"></i> <span id="totalStocks">0</span></h3>
                            <p class="text-muted">æ€»æ¨èæ•°</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h3><i class="fas fa-chart-line text-primary"></i> <span id="avgReturn">0%</span></h3>
                            <p class="text-muted">å¹³å‡å›æŠ¥ç‡</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h3><i class="fas fa-bolt text-warning"></i> <span id="warrantCount">0</span></h3>
                            <p class="text-muted">å‡­å•æ•°é‡</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h3><i class="fas fa-exclamation-triangle text-danger"></i> <span id="highRiskCount">0</span></h3>
                            <p class="text-muted">é«˜é£é™©è‚¡ç¥¨</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KLSEæ“ä½œæŒ‡å— -->
            <div class="alert-box m-4">
                <h4><i class="fas fa-mobile-alt"></i> KLSE Screeneræ“ä½œæŒ‡å—</h4>
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-bullseye text-success"></i> è®¾ç½®ç›ˆåˆ©ç›®æ ‡ (+10%)</h5>
                        <ol>
                            <li>æ‰“å¼€KLSE Screener App</li>
                            <li>æœç´¢ä¸‹æ–¹è‚¡ç¥¨ä»£ç </li>
                            <li>ç‚¹å‡»å³ä¸Šè§’"é“ƒé“›"å›¾æ ‡</li>
                            <li>é€‰æ‹©"Price Above"</li>
                            <li>è¾“å…¥å¯¹åº”çš„<strong>ç›®æ ‡ä»·</strong></li>
                        </ol>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-shield-alt text-danger"></i> è®¾ç½®æ­¢æŸä½</h5>
                        <ol>
                            <li>åœ¨åŒä¸€è‚¡ç¥¨é¡µé¢</li>
                            <li>å†æ¬¡ç‚¹å‡»"é“ƒé“›"å›¾æ ‡</li>
                            <li>é€‰æ‹©"Price Below"</li>
                            <li>è¾“å…¥å¯¹åº”çš„<strong>æ­¢æŸä»·</strong></li>
                            <li>ä¿å­˜æé†’</li>
                        </ol>
                    </div>
                </div>
                <button class="btn klse-action-btn" onclick="window.open('klse-guide.html', '_blank')">
                    <i class="fas fa-book"></i> æŸ¥çœ‹å®Œæ•´KLSEä½¿ç”¨æ•™ç¨‹
                </button>
            </div>

            <!-- è‚¡ç¥¨åˆ—è¡¨ -->
            <div class="p-4">
                <h3><i class="fas fa-list"></i> AIæ¨èè‚¡ç¥¨åˆ—è¡¨</h3>
                <div class="row" id="stocksContainer">
                    <!-- è‚¡ç¥¨å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-3">æ­£åœ¨åŠ è½½AIé€‰è‚¡æ•°æ®...</p>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="p-4 border-top">
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-success w-100 py-3" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary w-100 py-3" onclick="generateKLSEImport()">
                            <i class="fas fa-file-export"></i> ç”ŸæˆKLSEå¯¼å…¥æ–‡ä»¶
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== é…ç½®æ•°æ®æºè·¯å¾„ ==========
        const DATA_SOURCES = {
            latest: 'https://bursasearch.github.io/myx_shop/web/picks_latest.json',
            history: 'web/history/',
            prices: 'web/latest_price.json'
        };

        // ========== ä¸»æ•°æ®å¯¹è±¡ ==========
        let aiStocks = [];
        let lastUpdateTime = '';

        // ========== æ·»åŠ  KLSE Screener é€£çµå‡½æ•¸ ==========
        function openKLSEInApp(code) {
            // å˜—è©¦æ‰“é–‹ KLSE Screener App
            window.location.href = `klsescreener://stock/${code}`;
            
            // å¦‚æœ App æœªå®‰è£ï¼Œ500ms å¾Œæ‰“é–‹ç¶²é ç‰ˆ
            setTimeout(() => {
                window.open(`https://www.klsescreener.com/v2/stocks/view/${code}`, '_blank');
            }, 500);
        }

        // ========== åˆå§‹åŒ–é¡µé¢ ==========
        async function initDashboard() {
            try {
                // 1. åŠ è½½æœ€æ–°AIé€‰è‚¡æ•°æ®
                const response = await fetch(DATA_SOURCES.latest + '?t=' + Date.now());
                if (!response.ok) throw new Error('æ— æ³•åŠ è½½æ•°æ®');
                
                const data = await response.json();
                aiStocks = data.picks || [];
                lastUpdateTime = data.last_updated || data.date;
                
                // 2. æ›´æ–°UI
                updateStatistics();
                renderStockCards();
                updateLastUpdateTime();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('stocksContainer').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> æ— æ³•åŠ è½½æ•°æ®: ${error.message}
                            <button class="btn btn-sm btn-warning ms-3" onclick="loadSampleData()">
                                åŠ è½½ç¤ºä¾‹æ•°æ®
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // ========== æ›´æ–°ç»Ÿè®¡æ•°æ® ==========
        function updateStatistics() {
            document.getElementById('totalStocks').textContent = aiStocks.length;
            
            // è®¡ç®—å¹³å‡å›æŠ¥ç‡ - ä½¿ç”¨ daily_change å­—æ®µ
            const avgChange = aiStocks.reduce((sum, stock) => sum + (stock.daily_change || 0), 0) / aiStocks.length;
            document.getElementById('avgReturn').textContent = avgChange.toFixed(2) + '%';
            
            // è®¡ç®—å‡­å•æ•°é‡ - éœ€è¦æ ¹æ®ä»£ç åˆ¤æ–­æ˜¯å¦ä¸ºå‡­å•ï¼ˆé€šå¸¸åŒ…å«-WB, -Cxç­‰åç¼€ï¼‰
            const warrantCount = aiStocks.filter(s => {
                // ç®€å•çš„å‡­å•åˆ¤æ–­ï¼šå¦‚æœä»£ç åŒ…å«å­—æ¯åç¼€æˆ–ä»·æ ¼è¾ƒä½ï¼ˆé€šå¸¸å‡­å•ä»·ä½ä½ï¼‰
                return s.code.includes('-C') || s.code.includes('-W') || (s.price && s.price < 0.5 && s.price > 0);
            }).length;
            document.getElementById('warrantCount').textContent = warrantCount;
            
            // è®¡ç®—é«˜é£é™©è‚¡ç¥¨ (å‡­å•æˆ–è¯„åˆ†ä½äº70)
            const highRiskCount = aiStocks.filter(s => {
                const isWarrant = s.code.includes('-C') || s.code.includes('-W') || (s.price && s.price < 0.5 && s.price > 0);
                return isWarrant || (s.total_score || 0) < 70;
            }).length;
            document.getElementById('highRiskCount').textContent = highRiskCount;
        }

        // ========== æ¸²æŸ“è‚¡ç¥¨å¡ç‰‡ ==========
        function renderStockCards() {
            const container = document.getElementById('stocksContainer');
            
            if (aiStocks.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> æš‚æ— AIé€‰è‚¡æ•°æ®
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            aiStocks.forEach(stock => {
                // åˆ¤æ–­æ˜¯å¦ä¸ºå‡­å•ï¼ˆé€šè¿‡ä»£ç åç¼€å’Œä»·æ ¼ç»¼åˆåˆ¤æ–­ï¼‰
                const isWarrant = stock.code.includes('-C') || stock.code.includes('-W') || (stock.price < 0.5 && stock.price > 0);
                const cardClass = isWarrant ? 'warrant' : 'stock';
                const changeClass = (stock.daily_change || 0) >= 0 ? 'positive' : 'negative';
                const changeSign = (stock.daily_change || 0) >= 0 ? '+' : '';
                
                // ä¿®å¤ï¼šä½¿ç”¨ price è€Œä¸æ˜¯ current_price
                const currentPrice = stock.price || 0;
                const targetPrice = (currentPrice * 1.1).toFixed(3);
                // ä¿®å¤ï¼šä½¿ç”¨ total_score è€Œä¸æ˜¯ score
                const stopLossRatio = isWarrant ? 0.80 : (stock.total_score >= 80 ? 0.92 : 0.90);
                const stopLossPrice = (currentPrice * stopLossRatio).toFixed(3);
                
                // ä¿®å¤ï¼šè¿›åº¦æ¡é¢œè‰²åŸºäº total_score
                const scoreValue = stock.total_score || 0;
                const scoreColorClass = scoreValue >= 80 ? 'bg-success' : (scoreValue >= 70 ? 'bg-warning' : 'bg-danger');
                
                html += `
                <div class="col-md-6 col-lg-4">
                    <div class="card stock-card ${cardClass}" onclick="openKLSEInApp('${stock.code}')">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="card-title mb-1">
                                        ${stock.code} 
                                        <small class="text-muted">${stock.name || ''}</small>
                                    </h5>
                                    <span class="badge ${isWarrant ? 'bg-danger' : 'bg-success'}">
                                        ${isWarrant ? 'ğŸ“ˆ WARRANT' : 'ğŸ“Š STOCK'}
                                    </span>
                                    <span class="badge bg-secondary">${stock.sector_name || 'Other'}</span>
                                </div>
                                <div class="text-end">
                                    <h4 class="${changeClass} mb-0">
                                        RM ${currentPrice.toFixed(3)}
                                    </h4>
                                    <small class="${changeClass}">
                                        ${changeSign}${(stock.daily_change || 0).toFixed(2)}%
                                    </small>
                                </div>
                            </div>
                            
                            <!-- è¯„åˆ†è¿›åº¦æ¡ - ä¿®å¤ï¼šä½¿ç”¨ total_score -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>AIè¯„åˆ†</small>
                                    <small>${scoreValue}/100</small>
                                </div>
                                <div class="progress progress-bar-custom">
                                    <div class="progress-bar ${scoreColorClass}" 
                                         style="width: ${scoreValue}%">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- KLSEæ“ä½œæŒ‡å— -->
                            <div class="alert alert-light p-2 mb-2">
                                <small><strong>ğŸ¯ KLSE Screenerè®¾ç½®ï¼š</strong></small>
                                <table class="table table-sm table-borderless mb-0">
                                    <tr>
                                        <td><i class="fas fa-bullseye text-success"></i></td>
                                        <td>ç›ˆåˆ©ç›®æ ‡</td>
                                        <td class="text-end"><strong>RM ${targetPrice}</strong></td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-shield-alt text-danger"></i></td>
                                        <td>æ­¢æŸä½</td>
                                        <td class="text-end"><strong>RM ${stopLossPrice}</strong></td>
                                    </tr>
                                </table>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="event.stopPropagation(); copyKLSEAlert('${stock.code}', ${currentPrice}, ${targetPrice}, ${stopLossPrice})">
                                    <i class="fas fa-copy"></i> å¤åˆ¶è®¾ç½®
                                </button>
                                <button class="btn btn-sm klse-action-btn" 
                                        onclick="event.stopPropagation(); viewStockDetails('${stock.code}')">
                                    <i class="fas fa-search"></i> æŸ¥çœ‹è¯¦æƒ…
                                </button>
                            </div>
                            <small class="text-muted d-block text-center mt-2">
                                ğŸ‘† ç‚¹å‡»å¡ç‰‡ç›´æ¥æ‰“å¼€ KLSE Screener
                            </small>
                        </div>
                    </div>
                </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== å¤åˆ¶KLSEè®¾ç½®åˆ°å‰ªè´´æ¿ ==========
        function copyKLSEAlert(code, current, target, stopLoss) {
            event.stopPropagation();
            const text = `è‚¡ç¥¨: ${code}\nå½“å‰ä»·: RM ${current.toFixed(3)}\n\nğŸ¯ KLSE Screenerè®¾ç½®:\n1. ç›ˆåˆ©ç›®æ ‡: RM ${target} (+10%)\n2. æ­¢æŸä½: RM ${stopLoss}\n\næ“ä½œæ­¥éª¤:\nâ€¢ æœç´¢è‚¡ç¥¨ ${code}\nâ€¢ ç‚¹å‡»å³ä¸Šè§’é“ƒé“›å›¾æ ‡\nâ€¢ è®¾ç½® Price Above: ${target}\nâ€¢ è®¾ç½® Price Below: ${stopLoss}`;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… KLSEè®¾ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·æ‰“å¼€KLSE Screener Appå¹¶æŒ‰ç…§è¯´æ˜è®¾ç½®æé†’ã€‚');
            }).catch(() => {
                prompt('è¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹æ–‡æœ¬:', text);
            });
        }

        // ========== ç”ŸæˆKLSEå¯¼å…¥æ–‡ä»¶ ==========
        function generateKLSEImport() {
            const importData = {
                generated_at: new Date().toISOString(),
                watchlist_name: `AI_Picks_${new Date().toISOString().slice(0,10)}`,
                stocks: aiStocks.map(stock => {
                    const isWarrant = stock.code.includes('-C') || stock.code.includes('-W') || (stock.price < 0.5 && stock.price > 0);
                    return {
                        code: stock.code,
                        name: stock.name,
                        type: isWarrant ? 'Warrant' : 'Stock',
                        current_price: stock.price,  // ä¿®å¤ï¼šä½¿ç”¨ price
                        target_price: (stock.price * 1.1).toFixed(3),
                        stop_loss_price: (stock.price * (isWarrant ? 0.80 : 0.90)).toFixed(3)
                    };
                })
            };
            
            const jsonStr = JSON.stringify(importData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `KLSE_Import_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert('âœ… KLSEå¯¼å…¥æ–‡ä»¶å·²ç”Ÿæˆï¼');
        }

        // ========== æŸ¥çœ‹è‚¡ç¥¨è¯¦æƒ… ==========
        function viewStockDetails(code) {
            event.stopPropagation();
            window.open(`stock-detail.html?code=${code}`, '_blank');
        }

        // ========== åˆ·æ–°æ•°æ® ==========
        function refreshData() {
            location.reload();
        }

        // ========== æ›´æ–°æœ€åæ›´æ–°æ—¶é—´ ==========
        function updateLastUpdateTime() {
            document.getElementById('lastUpdateTime').textContent = lastUpdateTime || 'æœªçŸ¥';
        }

        // ========== åŠ è½½ç¤ºä¾‹æ•°æ®ï¼ˆå¤‡ç”¨ï¼‰ ==========
        function loadSampleData() {
            aiStocks = [
                {
                    code: '5296',
                    name: 'MR DIY',
                    price: 1.65,
                    daily_change: 2.5,
                    total_score: 85,
                    sector_name: 'Retail'
                },
                {
                    code: '5285',
                    name: 'SUNWAY',
                    price: 2.12,
                    daily_change: 1.8,
                    total_score: 82,
                    sector_name: 'Property'
                }
            ];
            
            updateStatistics();
            renderStockCards();
            document.getElementById('lastUpdateTime').textContent = '2024-02-10 (ç¤ºä¾‹æ•°æ®)';
        }

        // ========== é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>