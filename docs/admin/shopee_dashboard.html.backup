<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Shopee ç®¡ç†åå° - API ç‰ˆæœ¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial; margin: 16px; background:#f7f7f7; color:#222; }
    header { display:flex; flex-wrap:wrap; align-items:center; gap:12px; margin-bottom:16px; }
    header h1 { margin:0; font-size:20px; }
    .stats { font-size:14px; color:#555; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:16px; }
    .grid { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:14px; }
    th { background:#fafafa; }
    button { padding:6px 10px; border:1px solid #ccc; border-radius:6px; background:#fff; cursor:pointer; }
    button.primary { background:#0b74de; color:#fff; border-color:#0b74de; }
    button.warn { background:#b00020; color:#fff; border-color:#b00020; }
    button.success { background:#28a745; color:#fff; border-color:#28a745; }
    input, select { padding:6px 8px; border:1px solid #ccc; border-radius:6px; font-size:14px; width:100%; }
    form .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    form .row > * { flex:1 1 160px; }
    .duplicate-warning { background:#fff3cd; border:1px solid #ffeaa7; border-radius:4px; padding:8px; margin:8px 0; font-size:13px; }
    .error-input { border-color:#dc3545 !important; background-color:#f8d7da; }
    .validation-info { font-size:12px; color:#666; margin-top:4px; }
    .status-badge { padding:2px 6px; border-radius:10px; font-size:11px; font-weight:500; }
    .status-active { background:#d4edda; color:#155724; }
    .status-inactive { background:#f8d7da; color:#721c24; }
    .search-box { margin-bottom:12px; padding:6px 8px; border:1px solid #ccc; border-radius:6px; width:200px; }
    .filter-bar { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .link-cell { max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; width:90%; max-width:500px; }
    .modal-buttons { display:flex; gap:8px; justify-content:flex-end; margin-top:16px; }
    .connection-status { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:5px; }
    .connected { background:#28a745; }
    .disconnected { background:#dc3545; }
    .api-status { font-size:12px; color:#666; margin-left:10px; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ›ï¸ Shopee ç®¡ç†åå° - API ç‰ˆæœ¬</h1>
    <div class="stats">
      <span class="connection-status" id="connectionStatus"></span>
      çŠ¶æ€: <span id="connectionText">æ£€æŸ¥ä¸­...</span>
      <span class="api-status">æœåŠ¡å™¨: http://127.0.0.1:5050</span>
    </div>
    <div class="toolbar">
      <button id="refreshBtn">ğŸ”„ åˆ·æ–°</button>
      <button id="saveBtn" class="primary">ğŸ’¾ ä¿å­˜æ•°æ®</button>
      <button id="checkDuplicatesBtn" class="warn">ğŸ” æ£€æŸ¥é‡å¤</button>
      <button id="backupBtn" class="success">ğŸ“¥ ä¸‹è½½å¤‡ä»½</button>
    </div>
  </header>

  <section class="card">
    <h2 style="margin:0 0 8px;">â• æ·»åŠ æ–°äº§å“</h2>
    <div id="duplicateAlert" class="duplicate-warning" style="display:none;">
      âš ï¸ <strong>é‡å¤æ•°æ®è­¦å‘Š:</strong> <span id="duplicateMessage"></span>
    </div>
    <form id="addForm">
      <div class="row">
        <div>
          <input name="name" placeholder="äº§å“åç§° *" required />
          <div class="validation-info">å¿…å¡«å­—æ®µï¼Œè‡ªåŠ¨æ£€æŸ¥é‡å¤</div>
        </div>
        <div>
          <input name="price" type="number" step="0.01" placeholder="ä»·æ ¼ (RM) *" required />
        </div>
        <div>
          <input name="stock" type="number" placeholder="åº“å­˜æ•°é‡ *" required />
        </div>
        <div>
          <input name="image" placeholder="å›¾ç‰‡æ–‡ä»¶å" id="imageInput" />
          <div class="validation-info">ä¾‹å¦‚: sh-61_1112.pngï¼Œè‡ªåŠ¨æ£€æŸ¥é‡å¤</div>
        </div>
        <div>
          <input name="link" placeholder="Shopeeå•†å“é“¾æ¥" id="linkInput" />
          <div class="validation-info">è‡ªåŠ¨æ£€æŸ¥é“¾æ¥é‡å¤</div>
        </div>
        <div>
          <select name="category" required>
            <option value="">é€‰æ‹©åˆ†ç±» *</option>
            <option value="health">ä¿å¥å…»ç”Ÿ</option>
            <option value="home">å®¶å±…ç”Ÿæ´»</option>
            <option value="electronic">ç”µå­äº§å“</option>
            <option value="book">å›¾ä¹¦æ–‡å…·</option>
          </select>
        </div>
      </div>
      <div class="row">
        <button type="submit" class="primary">âœ… æ·»åŠ äº§å“</button>
        <button type="button" onclick="clearForm()">ğŸ—‘ï¸ æ¸…ç©ºè¡¨å•</button>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="filter-bar">
      <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢äº§å“åç§°..." class="search-box" />
      <select id="statusFilter">
        <option value="all">æ‰€æœ‰çŠ¶æ€</option>
        <option value="active">ä»…ä¸Šæ¶</option>
        <option value="inactive">ä»…ä¸‹æ¶</option>
      </select>
      <select id="categoryFilter">
        <option value="all">æ‰€æœ‰åˆ†ç±»</option>
        <option value="health">ä¿å¥å…»ç”Ÿ</option>
        <option value="home">å®¶å±…ç”Ÿæ´»</option>
        <option value="electronic">ç”µå­äº§å“</option>
        <option value="book">å›¾ä¹¦æ–‡å…·</option>
      </select>
    </div>
    
    <div class="grid">
      <table id="productTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>åç§°</th>
            <th>ä»·æ ¼</th>
            <th>åº“å­˜</th>
            <th>çŠ¶æ€</th>
            <th>åˆ†ç±»</th>
            <th>å›¾ç‰‡</th>
            <th>Shopeeé“¾æ¥</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ç¼–è¾‘äº§å“æ¨¡æ€æ¡† -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>ç¼–è¾‘äº§å“</h3>
      <form id="editForm">
        <input type="hidden" id="editId" name="id">
        <div class="row">
          <div>
            <label>äº§å“åç§° *</label>
            <input type="text" id="editName" name="name" required>
          </div>
          <div>
            <label>ä»·æ ¼ (RM) *</label>
            <input type="number" step="0.01" id="editPrice" name="price" required>
          </div>
          <div>
            <label>åº“å­˜æ•°é‡ *</label>
            <input type="number" id="editStock" name="stock" required>
          </div>
        </div>
        <div class="row">
          <div>
            <label>å›¾ç‰‡æ–‡ä»¶å</label>
            <input type="text" id="editImage" name="image">
            <div class="validation-info">è‡ªåŠ¨æ£€æŸ¥é‡å¤</div>
          </div>
          <div>
            <label>Shopeeå•†å“é“¾æ¥</label>
            <input type="text" id="editLink" name="link">
            <div class="validation-info">è‡ªåŠ¨æ£€æŸ¥é“¾æ¥é‡å¤</div>
          </div>
          <div>
            <label>åˆ†ç±» *</label>
            <select id="editCategory" name="category" required>
              <option value="health">ä¿å¥å…»ç”Ÿ</option>
              <option value="home">å®¶å±…ç”Ÿæ´»</option>
              <option value="electronic">ç”µå­äº§å“</option>
              <option value="book">å›¾ä¹¦æ–‡å…·</option>
            </select>
          </div>
        </div>
        <div id="editDuplicateAlert" class="duplicate-warning" style="display:none; margin-top:12px;">
          âš ï¸ <strong>é‡å¤æ•°æ®è­¦å‘Š:</strong> <span id="editDuplicateMessage"></span>
        </div>
        <div class="modal-buttons">
          <button type="button" onclick="closeEditModal()">å–æ¶ˆ</button>
          <button type="submit" class="primary">ä¿å­˜æ›´æ”¹</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // API é…ç½® - ä½¿ç”¨ä½ çš„æœ¬åœ°æœåŠ¡å™¨
    const API_BASE = 'http://127.0.0.1:5050';
    const JSON_FILE = 'shopee_list.json';  // å•æ•° list
    
    let allProducts = [];
    let isConnected = false;

    // æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
    async function checkServerConnection() {
      try {
        const response = await fetch(`${API_BASE}/`, { method: 'HEAD' });
        isConnected = response.ok;
        
        const statusElement = document.getElementById('connectionStatus');
        const textElement = document.getElementById('connectionText');
        
        if (isConnected) {
          statusElement.className = 'connection-status connected';
          textElement.textContent = 'å·²è¿æ¥';
          console.log('âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
        } else {
          statusElement.className = 'connection-status disconnected';
          textElement.textContent = 'æœªè¿æ¥';
          console.warn('âš ï¸ æœåŠ¡å™¨è¿æ¥å¤±è´¥');
        }
      } catch (error) {
        console.error('è¿æ¥æ£€æŸ¥å¤±è´¥:', error);
        isConnected = false;
        
        const statusElement = document.getElementById('connectionStatus');
        const textElement = document.getElementById('connectionText');
        statusElement.className = 'connection-status disconnected';
        textElement.textContent = 'è¿æ¥å¤±è´¥';
      }
    }

    // é‡å¤æ£€æŸ¥å‡½æ•°
    function checkDuplicates(newProduct, currentProducts) {
      const duplicates = {
        name: false,
        image: false,
        link: false,
        messages: []
      };

      const nameDuplicate = currentProducts.find(p => 
        p.name.toLowerCase() === newProduct.name.toLowerCase() && p.id !== newProduct.id
      );
      if (nameDuplicate) {
        duplicates.name = true;
        duplicates.messages.push(`äº§å“åç§°é‡å¤: "${newProduct.name}" (ID: ${nameDuplicate.id})`);
      }

      if (newProduct.image) {
        const imageDuplicate = currentProducts.find(p => 
          p.image === newProduct.image && p.id !== newProduct.id
        );
        if (imageDuplicate) {
          duplicates.image = true;
          duplicates.messages.push(`å›¾ç‰‡æ–‡ä»¶åé‡å¤: "${newProduct.image}" (ID: ${imageDuplicate.id})`);
        }
      }

      if (newProduct.link) {
        const linkDuplicate = currentProducts.find(p => 
          p.link === newProduct.link && p.id !== newProduct.id
        );
        if (linkDuplicate) {
          duplicates.link = true;
          duplicates.messages.push(`å•†å“é“¾æ¥é‡å¤: "${newProduct.link}" (ID: ${linkDuplicate.id})`);
        }
      }

      return duplicates;
    }

    // å®æ—¶è¾“å…¥éªŒè¯
    function setupRealTimeValidation() {
      const nameInput = document.querySelector('input[name="name"]');
      const imageInput = document.getElementById('imageInput');
      const linkInput = document.getElementById('linkInput');

      nameInput.addEventListener('blur', validateName);
      imageInput.addEventListener('blur', validateImage);
      linkInput.addEventListener('blur', validateLink);

      // ç¼–è¾‘è¡¨å•çš„å®æ—¶éªŒè¯
      const editNameInput = document.getElementById('editName');
      const editImageInput = document.getElementById('editImage');
      const editLinkInput = document.getElementById('editLink');

      editNameInput.addEventListener('blur', validateEditName);
      editImageInput.addEventListener('blur', validateEditImage);
      editLinkInput.addEventListener('blur', validateEditLink);
    }

    function validateName() {
      const name = this.value.trim();
      if (!name) return;
      
      const duplicate = allProducts.find(p => 
        p.name.toLowerCase() === name.toLowerCase()
      );
      
      if (duplicate) {
        this.classList.add('error-input');
        showDuplicateAlert(`äº§å“åç§°é‡å¤: "${name}" (å·²å­˜åœ¨äºID: ${duplicate.id})`);
      } else {
        this.classList.remove('error-input');
        hideDuplicateAlert();
      }
    }

    function validateImage() {
      const image = this.value.trim();
      if (!image) {
        this.classList.remove('error-input');
        hideDuplicateAlert();
        return;
      }
      
      const duplicate = allProducts.find(p => p.image === image);
      
      if (duplicate) {
        this.classList.add('error-input');
        showDuplicateAlert(`å›¾ç‰‡æ–‡ä»¶åé‡å¤: "${image}" (å·²å­˜åœ¨äºID: ${duplicate.id})`);
      } else {
        this.classList.remove('error-input');
        hideDuplicateAlert();
      }
    }

    function validateLink() {
      const link = this.value.trim();
      if (!link) {
        this.classList.remove('error-input');
        hideDuplicateAlert();
        return;
      }
      
      const duplicate = allProducts.find(p => p.link === link);
      
      if (duplicate) {
        this.classList.add('error-input');
        showDuplicateAlert(`å•†å“é“¾æ¥é‡å¤: "${link}" (å·²å­˜åœ¨äºID: ${duplicate.id})`);
      } else {
        this.classList.remove('error-input');
        hideDuplicateAlert();
      }
    }

    // ç¼–è¾‘è¡¨å•çš„éªŒè¯å‡½æ•°
    function validateEditName() {
      const name = this.value.trim();
      const editId = parseInt(document.getElementById('editId').value);
      if (!name) return;
      
      const duplicate = allProducts.find(p => 
        p.name.toLowerCase() === name.toLowerCase() && p.id !== editId
      );
      
      if (duplicate) {
        this.classList.add('error-input');
        showEditDuplicateAlert(`äº§å“åç§°é‡å¤: "${name}" (å·²å­˜åœ¨äºID: ${duplicate.id})`);
      } else {
        this.classList.remove('error-input');
        hideEditDuplicateAlert();
      }
    }

    function validateEditImage() {
      const image = this.value.trim();
      const editId = parseInt(document.getElementById('editId').value);
      if (!image) {
        this.classList.remove('error-input');
        hideEditDuplicateAlert();
        return;
      }
      
      const duplicate = allProducts.find(p => p.image === image && p.id !== editId);
      
      if (duplicate) {
        this.classList.add('error-input');
        showEditDuplicateAlert(`å›¾ç‰‡æ–‡ä»¶åé‡å¤: "${image}" (å·²å­˜åœ¨äºID: ${duplicate.id})`);
      } else {
        this.classList.remove('error-input');
        hideEditDuplicateAlert();
      }
    }

    function validateEditLink() {
      const link = this.value.trim();
      const editId = parseInt(document.getElementById('editId').value);
      if (!link) {
        this.classList.remove('error-input');
        hideEditDuplicateAlert();
        return;
      }
      
      const duplicate = allProducts.find(p => p.link === link && p.id !== editId);
      
      if (duplicate) {
        this.classList.add('error-input');
        showEditDuplicateAlert(`å•†å“é“¾æ¥é‡å¤: "${link}" (å·²å­˜åœ¨äºID: ${duplicate.id})`);
      } else {
        this.classList.remove('error-input');
        hideEditDuplicateAlert();
      }
    }

    function showDuplicateAlert(message) {
      const alert = document.getElementById('duplicateAlert');
      const messageSpan = document.getElementById('duplicateMessage');
      messageSpan.textContent = message;
      alert.style.display = 'block';
    }

    function hideDuplicateAlert() {
      document.getElementById('duplicateAlert').style.display = 'none';
    }

    function showEditDuplicateAlert(message) {
      const alert = document.getElementById('editDuplicateAlert');
      const messageSpan = document.getElementById('editDuplicateMessage');
      messageSpan.textContent = message;
      alert.style.display = 'block';
    }

    function hideEditDuplicateAlert() {
      document.getElementById('editDuplicateAlert').style.display = 'none';
    }

    // ä»APIåŠ è½½æ•°æ®
    async function loadData() {
      try {
        console.log(`æ­£åœ¨ä» ${API_BASE}/js/${JSON_FILE} åŠ è½½æ•°æ®...`);
        
        // å°è¯•ä»APIè·å–æ•°æ®
        const res = await fetch(`${API_BASE}/js/${JSON_FILE}`);
        
        if (!res.ok) {
          // å¦‚æœAPIå¤±è´¥ï¼Œå°è¯•ç›´æ¥æ–‡ä»¶è·¯å¾„
          console.log('APIè·å–å¤±è´¥ï¼Œå°è¯•ç›´æ¥æ–‡ä»¶è·¯å¾„...');
          const localRes = await fetch(`../js/${JSON_FILE}`);
          if (!localRes.ok) {
            throw new Error(`æ— æ³•åŠ è½½æ•°æ®æ–‡ä»¶: ${res.status} - ${localRes.status}`);
          }
          const data = await localRes.json();
          processLoadedData(data);
          return;
        }
        
        const data = await res.json();
        processLoadedData(data);
        
      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        
        // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
        let errorMsg = `æ— æ³•åŠ è½½æ•°æ®: ${error.message}\n\n`;
        errorMsg += `è¯·æ£€æŸ¥:\n`;
        errorMsg += `1. æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ: ${API_BASE}\n`;
        errorMsg += `2. æ–‡ä»¶æ˜¯å¦å­˜åœ¨: js/${JSON_FILE}\n`;
        errorMsg += `3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸`;
        
        alert(errorMsg);
        
        // å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°æ®
        allProducts = [];
        updateDisplay({ products: [], totalProducts: 0, lastUpdated: new Date().toISOString() });
      }
    }

    function processLoadedData(data) {
      // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
      if (!data.products || !Array.isArray(data.products)) {
        throw new Error('JSONæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘productsæ•°ç»„');
      }
      
      allProducts = data.products || [];
      
      console.log(`âœ… æˆåŠŸåŠ è½½ ${allProducts.length} ä¸ªäº§å“`);
      console.log('æœ€åæ›´æ–°:', data.lastUpdated);
      
      updateDisplay(data);
      setupRealTimeValidation();
    }

    function updateDisplay(data) {
      document.getElementById("totalCount").textContent = data.totalProducts ?? allProducts.length;
      document.getElementById("lastUpdated").textContent = data.lastUpdated ? 
        new Date(data.lastUpdated).toLocaleString('zh-CN') : "â€”";

      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const categoryFilter = document.getElementById('categoryFilter').value;

      const filteredProducts = allProducts.filter(p => {
        const matchesSearch = p.name.toLowerCase().includes(searchTerm);
        const matchesStatus = statusFilter === 'all' || p.status === statusFilter;
        const matchesCategory = categoryFilter === 'all' || p.category === categoryFilter;
        return matchesSearch && matchesStatus && matchesCategory;
      });

      renderTable(filteredProducts);
    }

    function renderTable(products) {
      const tbody = document.querySelector("#productTable tbody");
      tbody.innerHTML = "";
      
      products.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td>RM ${Number(p.price).toFixed(2)}</td>
          <td>${p.stock}</td>
          <td><span class="status-badge ${p.status === 'active' ? 'status-active' : 'status-inactive'}">${p.status === 'active' ? 'ä¸Šæ¶' : 'ä¸‹æ¶'}</span></td>
          <td>${getCategoryName(p.category)}</td>
          <td>${p.image ? `<small>${p.image}</small>` : 'â€”'}</td>
          <td class="link-cell">${p.link ? `<a href="${p.link}" target="_blank" title="${p.link}">æŸ¥çœ‹é“¾æ¥</a>` : 'â€”'}</td>
          <td>
            <button onclick="openEditModal(${p.id})">âœï¸ ç¼–è¾‘</button>
            <button class="${p.status === 'active' ? 'warn' : 'success'}" onclick="toggleProductStatus(${p.id}, '${p.status || 'active'}')">
              ${p.status === 'active' ? 'â¬‡ï¸ ä¸‹æ¶' : 'â¬†ï¸ ä¸Šæ¶'}
            </button>
            <button class="warn" onclick="deleteProduct(${p.id})">ğŸ—‘ï¸ åˆ é™¤</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function getCategoryName(category) {
      const categoryMap = {
        'health': 'ä¿å¥å…»ç”Ÿ',
        'home': 'å®¶å±…ç”Ÿæ´»', 
        'electronic': 'ç”µå­äº§å“',
        'book': 'å›¾ä¹¦æ–‡å…·'
      };
      return categoryMap[category] || category || '';
    }

    // æ£€æŸ¥æ‰€æœ‰é‡å¤æ•°æ®
    async function checkAllDuplicates() {
      const duplicates = [];
      
      allProducts.forEach((product, index) => {
        const nameDuplicates = allProducts.filter((p, i) => 
          i !== index && p.name.toLowerCase() === product.name.toLowerCase()
        );
        
        const imageDuplicates = allProducts.filter((p, i) => 
          i !== index && p.image && p.image === product.image
        );
        
        const linkDuplicates = allProducts.filter((p, i) => 
          i !== index && p.link && p.link === product.link
        );

        if (nameDuplicates.length > 0) {
          duplicates.push(`ID ${product.id}: åç§°é‡å¤ "${product.name}"`);
        }
        if (imageDuplicates.length > 0) {
          duplicates.push(`ID ${product.id}: å›¾ç‰‡é‡å¤ "${product.image}"`);
        }
        if (linkDuplicates.length > 0) {
          duplicates.push(`ID ${product.id}: é“¾æ¥é‡å¤ "${product.link}"`);
        }
      });

      if (duplicates.length > 0) {
        alert('ğŸ” å‘ç°é‡å¤æ•°æ®:\n\n' + duplicates.join('\n'));
      } else {
        alert('âœ… æ²¡æœ‰å‘ç°é‡å¤æ•°æ®ï¼');
      }
    }

    // è¡¨å•æäº¤å¤„ç†
    document.getElementById("addForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      
      try {
        // ç”Ÿæˆæ–°IDï¼ˆç°æœ‰æœ€å¤§ID + 1ï¼‰
        const newId = allProducts.length > 0 ? Math.max(...allProducts.map(p => p.id)) + 1 : 1;
        
        const newProduct = {
          id: newId,
          name: form.name.value.trim(),
          price: parseFloat(form.price.value),
          stock: parseInt(form.stock.value),
          image: form.image.value.trim() || `sh-${newId}.png`,
          link: form.link.value.trim(),
          category: form.category.value || 'health',
          status: "active",
          sales: 0
        };

        // æäº¤å‰å†æ¬¡æ£€æŸ¥é‡å¤
        const duplicates = checkDuplicates(newProduct, allProducts);
        if (duplicates.messages.length > 0) {
          if (!confirm(`å‘ç°é‡å¤æ•°æ®:\n${duplicates.messages.join('\n')}\n\nä»ç„¶è¦æ·»åŠ å—ï¼Ÿ`)) {
            return;
          }
        }

        const updatedProducts = [...allProducts, newProduct];
        await saveProducts(updatedProducts);
        
        form.reset();
        alert("âœ… äº§å“æ·»åŠ æˆåŠŸ");
        loadData();
      } catch (error) {
        console.error('æ·»åŠ å¤±è´¥:', error);
        alert("é”™è¯¯: " + error.message);
      }
    });

    // ä¿å­˜äº§å“æ•°æ®åˆ°API
    async function saveProducts(products) {
      const dataToSave = {
        products: products,
        totalProducts: products.length,
        lastUpdated: new Date().toISOString()
      };
      
      try {
        // å°è¯•é€šè¿‡APIä¿å­˜
        console.log('æ­£åœ¨ä¿å­˜æ•°æ®åˆ°API...');
        const updateRes = await fetch(`${API_BASE}/save_shopee_data`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dataToSave)
        });
        
        if (!updateRes.ok) {
          // å¦‚æœAPIä¿å­˜å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¿å­˜åˆ°æ–‡ä»¶
          console.log('APIä¿å­˜å¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¿å­˜...');
          const directRes = await fetch(`${API_BASE}/js/${JSON_FILE}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dataToSave, null, 2)
          });
          
          if (!directRes.ok) {
            throw new Error(`ä¿å­˜å¤±è´¥: ${directRes.status} - ${directRes.statusText}`);
          }
          
          console.log('ç›´æ¥ä¿å­˜æˆåŠŸ');
        } else {
          console.log('APIä¿å­˜æˆåŠŸ');
        }
        
        // æ›´æ–°æœ¬åœ°æ•°æ®
        allProducts = products;
        
        return { success: true };
        
      } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        
        // æä¾›å¤‡ç”¨ä¿å­˜æ–¹æ¡ˆ - ä¸‹è½½æ–‡ä»¶
        downloadBackupFile(dataToSave);
        
        return { success: false, error: error.message };
      }
    }

    // ä¸‹è½½å¤‡ä»½æ–‡ä»¶
    function downloadBackupFile(data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'shopee_list_backup.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert(`ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥ï¼Œå·²ä¸‹è½½å¤‡ä»½æ–‡ä»¶: shopee_list_backup.json\n\nè¯·æ‰‹åŠ¨å°†æ–‡ä»¶å¤åˆ¶åˆ° js/${JSON_FILE}`);
    }

    // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
    function openEditModal(id) {
      const product = allProducts.find(p => p.id === id);
      if (!product) return;

      document.getElementById('editId').value = product.id;
      document.getElementById('editName').value = product.name;
      document.getElementById('editPrice').value = product.price;
      document.getElementById('editStock').value = product.stock;
      document.getElementById('editImage').value = product.image || '';
      document.getElementById('editLink').value = product.link || '';
      document.getElementById('editCategory').value = product.category || 'health';

      // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯çŠ¶æ€
      hideEditDuplicateAlert();
      document.querySelectorAll('#editForm .error-input').forEach(input => {
        input.classList.remove('error-input');
      });

      document.getElementById('editModal').style.display = 'block';
    }

    // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    // ç¼–è¾‘è¡¨å•æäº¤
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = parseInt(document.getElementById('editId').value);
      const updates = {
        name: document.getElementById('editName').value.trim(),
        price: parseFloat(document.getElementById('editPrice').value),
        stock: parseInt(document.getElementById('editStock').value),
        image: document.getElementById('editImage').value.trim(),
        link: document.getElementById('editLink').value.trim(),
        category: document.getElementById('editCategory').value
      };

      await editProduct(id, updates);
    });

    async function editProduct(id, updates) {
      const updatedProducts = allProducts.map(product => 
        product.id === id ? { ...product, ...updates } : product
      );

      // æ£€æŸ¥ç¼–è¾‘åçš„é‡å¤æ•°æ®
      const editedProduct = updatedProducts.find(p => p.id === id);
      const duplicates = checkDuplicates(editedProduct, updatedProducts.filter(p => p.id !== id));
      
      if (duplicates.messages.length > 0) {
        if (!confirm(`å‘ç°é‡å¤æ•°æ®:\n${duplicates.messages.join('\n')}\n\nä»ç„¶è¦æ›´æ–°å—ï¼Ÿ`)) {
          return;
        }
      }

      const result = await saveProducts(updatedProducts);
      if (result.success) {
        alert("âœ… äº§å“æ›´æ–°æˆåŠŸ");
        closeEditModal();
        loadData();
      } else {
        alert("é”™è¯¯: " + (result.error || "æœªçŸ¥é”™è¯¯"));
      }
    }

    async function toggleProductStatus(id, currentStatus) {
      const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
      const confirmMessage = newStatus === 'inactive' ? 'ç¡®å®šè¦ä¸‹æ¶è¿™ä¸ªäº§å“å—ï¼Ÿ' : 'ç¡®å®šè¦é‡æ–°ä¸Šæ¶è¿™ä¸ªäº§å“å—ï¼Ÿ';
      
      if (!confirm(confirmMessage)) return;

      const updatedProducts = allProducts.map(product => 
        product.id === id ? { ...product, status: newStatus } : product
      );

      const result = await saveProducts(updatedProducts);
      if (result.success) {
        alert(`äº§å“å·²${newStatus === 'inactive' ? 'ä¸‹æ¶' : 'ä¸Šæ¶'}`);
        loadData();
      } else {
        alert("é”™è¯¯: " + (result.error || "æœªçŸ¥é”™è¯¯"));
      }
    }

    async function deleteProduct(id) {
      const product = allProducts.find(p => p.id === id);
      if (!product) return;

      if (!confirm(`ç¡®å®šè¦åˆ é™¤äº§å“å—ï¼Ÿ\n\nID: ${product.id}\nåç§°: ${product.name}`)) return;

      const updatedProducts = allProducts.filter(p => p.id !== id);
      const result = await saveProducts(updatedProducts);
      
      if (result.success) {
        alert("âœ… äº§å“åˆ é™¤æˆåŠŸ");
        loadData();
      } else {
        alert("é”™è¯¯: " + (result.error || "æœªçŸ¥é”™è¯¯"));
      }
    }

    function clearForm() {
      document.getElementById('addForm').reset();
      hideDuplicateAlert();
      // æ¸…é™¤è¾“å…¥æ¡†çš„é”™è¯¯æ ·å¼
      document.querySelectorAll('.error-input').forEach(input => {
        input.classList.remove('error-input');
      });
    }

    // æ‰‹åŠ¨ä¿å­˜æ•°æ®ï¼ˆæŒ‰é’®åŠŸèƒ½ï¼‰
    async function manualSaveData() {
      try {
        await saveProducts(allProducts);
        alert("âœ… æ•°æ®ä¿å­˜æˆåŠŸï¼");
      } catch (error) {
        alert("ä¿å­˜å¤±è´¥: " + error.message);
      }
    }

    // äº‹ä»¶ç›‘å¬å™¨
    document.getElementById("refreshBtn").addEventListener("click", loadData);
    document.getElementById("saveBtn").addEventListener("click", manualSaveData);
    document.getElementById("checkDuplicatesBtn").addEventListener("click", checkAllDuplicates);
    document.getElementById("backupBtn").addEventListener("click", () => {
      downloadBackupFile({
        products: allProducts,
        totalProducts: allProducts.length,
        lastUpdated: new Date().toISOString()
      });
    });
    
    document.getElementById("searchInput").addEventListener("input", () => updateDisplay({products: allProducts}));
    document.getElementById("statusFilter").addEventListener("change", () => updateDisplay({products: allProducts}));
    document.getElementById("categoryFilter").addEventListener("change", () => updateDisplay({products: allProducts}));

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('editModal').addEventListener('click', (e) => {
      if (e.target.id === 'editModal') {
        closeEditModal();
      }
    });

    // åˆå§‹åŒ–
    async function init() {
      console.log('Shopeeç®¡ç†åå°åˆå§‹åŒ–...');
      console.log('APIåŸºç¡€åœ°å€:', API_BASE);
      console.log('JSONæ–‡ä»¶:', JSON_FILE);
      
      // æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
      await checkServerConnection();
      
      // åŠ è½½æ•°æ®
      await loadData();
      
      // å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€ï¼ˆæ¯30ç§’ï¼‰
      setInterval(checkServerConnection, 30000);
      
      console.log('âœ… ç®¡ç†åå°åˆå§‹åŒ–å®Œæˆ');
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>