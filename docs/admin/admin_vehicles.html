<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>车辆管理 | Myx Shop 管理员</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --expired: #95a5a6;
            --whatsapp: #25D366;
            --plate: #ff6b35;
            --bg: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Microsoft JhengHei','Segoe UI',sans-serif;
            background: var(--bg);
            color:#eee;
            min-height:100vh;
            padding:20px;
        }
        .container { max-width:1450px; margin:0 auto; }

        /* Header & Controls */
        .header { text-align:center; padding:40px 20px; color:white; }
        .header h1 { font-size:3rem; margin-bottom:10px; }
        .admin-controls {
            display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
            background:rgba(255,255,255,0.1); padding:20px; border-radius:15px; gap:15px;
            backdrop-filter:blur(10px); margin-bottom:30px;
        }
        .admin-actions { display:flex; gap:12px; flex-wrap:wrap; }
        .btn {
            padding:12px 20px; border:none; border-radius:10px; cursor:pointer;
            font-weight:600; display:inline-flex; align-items:center; gap:8px;
            transition:all .3s; text-decoration:none;
        }
        .btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,0,0,0.3); }
        .btn-primary { background:var(--primary); color:white; }
        .btn-success { background:var(--success); color:white; }
        .btn-warning { background:var(--warning); color:white; }
        .btn-danger { background:var(--danger); color:white; }

        /* Stats */
        .stats-panel {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
            gap:20px; margin-bottom:30px;
        }
        .stat-card {
            background:rgba(255,255,255,0.1); border-radius:15px; padding:20px;
            text-align:center; backdrop-filter:blur(10px);
        }
        .stat-value { font-size:2.6em; font-weight:bold; }
        .stat-label { opacity:0.9; font-size:0.95em; }

        /* Search & Filters */
        .search-box { position:relative; max-width:600px; margin:0 auto 30px; }
        .search-box input {
            width:100%; padding:18px 55px 18px 25px; border:none; border-radius:50px;
            font-size:1.1em; box-shadow:0 10px 30px rgba(0,0,0,0.2);
        }
        .search-box i { position:absolute; right:20px; top:50%; transform:translateY(-50%); color:#667eea; }

        .filters {
            display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin-bottom:40px;
        }
        .filter-btn {
            padding:12px 28px; border:none; border-radius:30px; background:rgba(255,255,255,0.15);
            color:white; cursor:pointer; transition:all .3s; backdrop-filter:blur(5px);
        }
        .filter-btn.active, .filter-btn:hover { background:var(--primary); }

        /* Grid */
        .vehicles-grid {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(360px,1fr)); gap:28px;
            margin-bottom:60px;
        }
        .vehicle-card {
            background:white; color:#333; border-radius:20px; overflow:hidden;
            box-shadow:0 12px 35px rgba(0,0,0,0.15); transition:all .4s;
        }
        .vehicle-card:hover { transform:translateY(-10px); box-shadow:0 25px 50px rgba(0,0,0,0.3); }
        .vehicle-card.expired { opacity:0.65; }
        .card-header { position:relative; height:230px; overflow:hidden; }
        .vehicle-image { width:100%; height:100%; object-fit:cover; transition:transform .4s; }
        .vehicle-card:hover .vehicle-image { transform:scale(1.08); }
        .plate-badge {
            position:absolute; top:15px; right:15px; background:var(--plate); color:white;
            padding:8px 18px; border-radius:30px; font-weight:bold; font-family:monospace;
        }
        .expire-badge {
            position:absolute; top:15px; left:15px; background:rgba(231,76,60,0.95); color:white;
            padding:6px 14px; border-radius:20px; font-size:0.85em; font-weight:bold;
        }
        .vehicle-info { padding:25px; }
        .vehicle-model { font-size:1.5em; font-weight:bold; display:flex; justify-content:space-between; }
        .vehicle-year { color:#667eea; }
        .vehicle-status { display:inline-block; padding:6px 16px; border-radius:20px; font-weight:bold; margin:10px 0; }
        .status-available { background:#e8f5e8; color:var(--success); }
        .status-sold { background:#fff3cd; color:#856404; }
        .status-reserved { background:#d1ecf1; color:#0c5460; }
        .status-expired { background:#f8d7da; color:#721c24; }
        .days-left {
            font-size:0.85em; color:#e74c3c; margin-top:8px; font-weight:bold;
        }
        .vehicle-price { font-size:2em; color:var(--plate); margin:15px 0; font-weight:bold; }
        .card-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:20px; }
        .action-btn {
            flex:1; padding:12px; border:none; border-radius:10px; font-weight:600;
            cursor:pointer; transition:all .3s; text-align:center; min-width:100px;
        }

        .no-results { grid-column:1/-1; text-align:center; padding:80px 20px; color:white; font-size:1.3em; }

        /* 批量操作区 */
        .batch-actions {
            text-align:center; margin:30px 0;
        }
        
        /* 功能标签 */
        .feature-tag {
            background: #f1f1f1;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            color: #555;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>车辆管理系统</h1>
        <p>Myx Shop 管理员后台 - 支持 30 天自动下架</p>
    </div>

    <div class="admin-controls">
        <div class="admin-actions">
            <button class="btn btn-success" id="addVehicleBtn"><i class="fas fa-plus-circle"></i> 添加新车</button>
            <button class="btn btn-primary" id="exportDataBtn"><i class="fas fa-file-export"></i> 导出 JSON</button>
            <button class="btn btn-warning" id="refreshBtn"><i class="fas fa-sync-alt"></i> 刷新</button>
            <button class="btn btn-danger" id="batchRemoveExpired"><i class="fas fa-trash-alt"></i> 一键清理过期车辆</button>
        </div>
        <div>
            <span style="color:white;">管理员：admin</span>
            <button class="btn btn-danger" id="logoutBtn" style="margin-left:10px;"><i class="fas fa-sign-out-alt"></i> 退出</button>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-panel">
        <div class="stat-card"><div class="stat-value" id="total">0</div><div class="stat-label">总车辆</div></div>
        <div class="stat-card"><div class="stat-value" id="available">0</div><div class="stat-label">待售</div></div>
        <div class="stat-card"><div class="stat-value" id="reserved">0</div><div class="stat-label">已预订</div></div>
        <div class="stat-card"><div class="stat-value" id="sold">0</div><div class="stat-label">已售出</div></div>
        <div class="stat-card"><div class="stat-value" id="expiring">0</div><div class="stat-label">7天内到期</div></div>
        <div class="stat-card"><div class="stat-value" id="expired">0</div><div class="stat-label">已过期</div></div>
    </div>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="搜索型号 / 车牌 / 特点 / 过期 ...">
        <i class="fas fa-search"></i>
    </div>

    <div class="filters">
        <button class="filter-btn active" data-filter="all">全部</button>
        <button class="filter-btn" data-filter="available">待售中</button>
        <button class="filter-btn" data-filter="reserved">已预订</button>
        <button class="filter-btn" data-filter="sold">已售出</button>
        <button class="filter-btn" data-filter="expiring">即将到期</button>
        <button class="filter-btn" data-filter="expired">已过期</button>
    </div>

    <div class="vehicles-grid" id="vehiclesGrid"></div>

    <div class="batch-actions" id="batchInfo" style="display:none;color:#fff;">
        检测到 <strong id="expiredCount">0</strong> 辆已过期车辆，
        <a href="javascript:void(0)" id="batchRemoveLink" style="color:#ff6b6b;text-decoration:underline;">点击这里一键移除</a>
    </div>
</div>

<script>
    // ==== 车辆资料（示范）====
    let vehicles = [
        {
            id: "daihatsu",
            model: "Daihatsu Feroza",
            year: 1996,
            plate: "BEU822",
            price: "RM 25,000",
            status: "available",
            category: ["suv","4wd"],
            description: "经典四轮驱动越野车，保养良好。",
            features: ["四轮驱动","手动档","高离地"],
            image: "../images/vehicles/ABC1111/cover.jpg",
            link: "ABC1111.html",
            whatsapp: "60189848128",
            addedDate: "2025-10-25",      // <--- 上架日期
            autoExpire: true              // 是否启用30天自动下架
        },
        {
            id: "storm",
            model: "Mitsubishi Storm",
            year: 2002,
            plate: "CBG9761",
            price: "RM 28,500",
            status: "available",
            addedDate: "2025-09-01",      // 已经超过30天 → 会自动变 expired
            autoExpire: true,
            image: "../images/vehicles/ABC1234A/cover.jpg",
            link: "ABC1234A.html",
            whatsapp: "60173912256"
        },
        {
            id: "kembara",
            model: "Perodua Kembara",
            year: 2001,
            plate: "MAS8543",
            price: "RM 15,800",
            status: "reserved",
            addedDate: "2025-11-15",
            autoExpire: true,
            image: "../images/vehicles/ABC1234/cover.jpg",
            link: "ABC1234.html",
            whatsapp: "60173912256"
        }
    ];

    // ==== 工具函数 ====
    function getDaysSince(dateStr) {
        const added = new Date(dateStr);
        const diff = Date.now() - added.getTime();
        return Math.floor(diff / (1000*60*60*24));
    }

    function getStatusInfo(v) {
        if (v.autoExpire !== false) {
            const days = getDaysSince(v.addedDate);
            if (days > 30) return { text: "已过期", class: "status-expired", daysLeft: -(days - 30) };
            if (days > 23) return { text: "即将到期", class: "status-warning", daysLeft: 30 - days };
        }
        const map = {
            available: { text: "待售中", class: "status-available" },
            sold: { text: "已售出", class: "status-sold" },
            reserved: { text: "已预订", class: "status-reserved" }
        };
        return map[v.status] || map.available;
    }

    function generateWhatsApp(vehicle) {
        const msg = encodeURIComponent(`您好，我對 Myx Shop 的《${vehicle.model}》(车牌 ${vehicle.plate}) 有興趣，想了解更多詳情。`);
        return `https://wa.me/${vehicle.whatsapp}?text=${msg}`;
    }

    // ==== 渲染 ====
    function render(list = vehicles) {
        const grid = document.getElementById('vehiclesGrid');
        if (!list.length) {
            grid.innerHTML = `<div class="no-results"><i class="fas fa-car" style="font-size:4em;"></i><h3>沒有找到符合條件的車輛</h3></div>`;
            return;
        }

        grid.innerHTML = '';
        list.forEach(v => {
            const status = getStatusInfo(v);
            const daysSince = getDaysSince(v.addedDate);
            const isExpired = v.autoExpire !== false && daysSince > 30;
            const daysLeft = isExpired ? -(daysSince - 30) : 30 - daysSince;

            const card = document.createElement('div');
            card.className = `vehicle-card ${isExpired ? 'expired' : ''}`;
            card.innerHTML = `
                <div class="card-header">
                    <img src="${v.image}" alt="${v.model}" class="vehicle-image"
                         onerror="this.style.display='none'; this.parentNode.style.background='#f0f0f0'; this.nextElementSibling.style.display='flex';">
                    <div class="vehicle-placeholder" style="display:none;background:#eee;color:#aaa;"><i class="fas fa-car"></i></div>
                    <div class="plate-badge">${v.plate}</div>
                    ${isExpired ? '<div class="expire-badge">已过期</div>' : 
                     v.autoExpire !== false && daysSince > 23 ? `<div class="expire-badge">剩 ${daysLeft} 天</div>` : ''}
                </div>
                <div class="vehicle-info">
                    <div class="vehicle-model">${v.model} <span class="vehicle-year">${v.year}</span></div>
                    <div class="vehicle-status ${status.class}">${status.text}</div>
                    <p class="vehicle-description">${v.description || ''}</p>
                    ${v.features ? `<div class="vehicle-features" style="margin:10px 0;display:flex;gap:8px;flex-wrap:wrap;">
                        ${v.features.map(f=>`<span class="feature-tag">${f}</span>`).join('')}
                    </div>` : ''}
                    <div class="vehicle-price">${v.price}</div>
                    <div style="font-size:0.85em;color:#777;">
                        上架日期：${v.addedDate}（${daysSince}天前）
                        ${v.autoExpire !== false ? `<span class="days-left"> → 剩余 ${daysLeft < 0 ? 0 : daysLeft} 天自动下架</span>` : ''}
                    </div>
                    <div class="card-actions">
                        <a href="${v.link}" target="_blank" class="action-btn btn-primary"><i class="fas fa-eye"></i> 详情</a>
                        <a href="${generateWhatsApp(v)}" target="_blank" class="action-btn" style="background:#25D366;color:white;"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                        <button class="action-btn btn-warning" onclick="editVehicle('${v.id}')"><i class="fas fa-edit"></i> 编辑</button>
                        <button class="action-btn btn-danger" onclick="deleteVehicle('${v.id}')"><i class="fas fa-trash"></i> 删除</button>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // ==== 统计 ====
    function updateStats() {
        const total = vehicles.length;
        const available = vehicles.filter(v => v.status === 'available').length;
        const sold = vehicles.filter(v => v.status === 'sold').length;
        const reserved = vehicles.filter(v => v.status === 'reserved').length;
        const expiring = vehicles.filter(v => v.autoExpire !== false && getDaysSince(v.addedDate) > 23 && getDaysSince(v.addedDate) <= 30).length;
        const expired = vehicles.filter(v => v.autoExpire !== false && getDaysSince(v.addedDate) > 30).length;

        document.getElementById('total').textContent = total;
        document.getElementById('available').textContent = available;
        document.getElementById('reserved').textContent = reserved;
        document.getElementById('sold').textContent = sold;
        document.getElementById('expiring').textContent = expiring;
        document.getElementById('expired').textContent = expired;

        // 底部一键清理提示
        if (expired > 0) {
            document.getElementById('expiredCount').textContent = expired;
            document.getElementById('batchInfo').style.display = 'block';
        } else {
            document.getElementById('batchInfo').style.display = 'none';
        }
    }

    // ==== 搜索 & 筛选 ====
    function performFilter() {
        const term = document.getElementById('searchInput').value.trim().toLowerCase();
        const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;

        let filtered = vehicles;

        // 文字搜索
        if (term) {
            filtered = filtered.filter(v =>
                v.model.toLowerCase().includes(term) ||
                v.plate.toLowerCase().includes(term) ||
                (v.description && v.description.toLowerCase().includes(term)) ||
                (v.features && v.features.some(f => f.toLowerCase().includes(term))) ||
                term.includes('过期') && getDaysSince(v.addedDate) > 30
            );
        }

        // 按钮筛选
        if (activeFilter === 'available') filtered = filtered.filter(v => v.status === 'available');
        else if (activeFilter === 'reserved') filtered = filtered.filter(v => v.status === 'reserved');
        else if (activeFilter === 'sold') filtered = filtered.filter(v => v.status === 'sold');
        else if (activeFilter === 'expiring') filtered = filtered.filter(v => v.autoExpire !== false && getDaysSince(v.addedDate) > 23 && getDaysSince(v.addedDate) <= 30);
        else if (activeFilter === 'expired') filtered = filtered.filter(v => v.autoExpire !== false && getDaysSince(v.addedDate) > 30);

        render(filtered);
    }

    // ==== 事件绑定 ====
    document.addEventListener('DOMContentLoaded', () => {
        render();
        updateStats();

        // 搜索
        document.getElementById('searchInput').addEventListener('input', performFilter);

        // 筛选按钮
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                performFilter();
            });
        });

        // 其他按钮
        document.getElementById('refreshBtn').onclick = () => { render(); updateStats(); };
        document.getElementById('exportDataBtn').onclick = () => {
            const data = JSON.stringify(vehicles, null, 2);
            const blob = new Blob([data], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'myx_vehicles.json'; a.click();
        };
        document.getElementById('batchRemoveExpired').onclick = document.getElementById('batchRemoveLink').onclick = () => {
            if (confirm(`确定要移除全部 ${document.getElementById('expired').textContent} 辆已过期车辆？`)) {
                vehicles = vehicles.filter(v => !(v.autoExpire !== false && getDaysSince(v.addedDate) > 30));
                render(); updateStats();
                alert('已清理完毕！');
            }
        };
        document.getElementById('logoutBtn').onclick = () => { if(confirm('确定退出？')) location.href ='../vehicles.html'; };
    });

    // 编辑 / 删除（示范）
    function editVehicle(id) { alert(`编辑功能待后端实作\nID: ${id}`); }
    function deleteVehicle(id) {
        if (confirm('确定删除这辆车？')) {
            const idx = vehicles.findIndex(v => v.id === id);
            if (idx > -1) vehicles.splice(idx, 1);
            render(); updateStats();
        }
    }
</script>
</body>
</html>