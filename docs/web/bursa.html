<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   
    <title>Bursa AIæŠ•èµ„è®¡ç®—å™¨ - ç”Ÿäº§åŒæ­¥ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ - è¿™é‡Œçœç•¥ä»¥èŠ‚çœç©ºé—´ï¼Œè¯·ä¿ç•™æ‚¨åŸæœ‰çš„CSS */
        :root {
            --primary: #2196F3; --primary-dark: #1976D2; --secondary: #4CAF50;
            --warning: #FF9800; --danger: #F44336; --light: #F5F7FA;
            --dark: #333333; --gray: #666666; --coffee: #FF9800;
            --success: #4CAF50;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark); line-height: 1.5; min-height: 100vh;
        }
        .container {
            width: 100%; max-width: 500px; margin: 0 auto; background: white;
            min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; padding: 20px 15px; position: sticky; top: 0; z-index: 100;
        }
        .tab-bar {
            display: flex; background: white; border-bottom: 1px solid var(--light);
            position: sticky; top: 90px; z-index: 99;
        }
        .tab { flex: 1; padding: 15px; text-align: center; color: var(--gray); cursor: pointer; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); font-weight: 600; }
        .content { padding: 15px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--light); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* è¨ˆç®—å™¨å¡ç‰‡æ¨£å¼ */
        .calculator-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
            border-left: 4px solid var(--primary);
            padding-left: 10px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-field {
            flex: 1;
        }
        
        .input-field input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .input-field input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        
        .info-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            display: block;
        }
        
        .summary-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .summary-text {
            font-size: 14px;
            color: #666;
        }
        
        .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin-top: 5px;
        }
        
        .divider {
            height: 1px;
            background: #e0e0e0;
            margin: 20px 0;
        }
        
        .result-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #d0d7e2;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .result-label {
            font-size: 14px;
            color: #666;
        }
        
        .result-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .profit-loss {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .profit {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .loss {
            background: #ffebee;
            color: #c62828;
        }
        
        .total-row {
            border-top: 2px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .footer-note {
            text-align: center;
            font-size: 11px;
            color: #999;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .btn-calculate {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }
        
        .btn-calculate:active {
            transform: translateY(0);
        }
        
        /* è‚¡ç¥¨å¡ç‰‡æ¨£å¼ */
        .stock-card { 
            border: 1px solid #eee; 
            border-radius: 8px; 
            padding: 12px; 
            margin-bottom: 10px; 
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .stock-card:hover { 
            background-color: #f9f9f9; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .stock-card.clickable { 
            border-left: 4px solid var(--primary); 
        }
        .stock-title { display: flex; justify-content: space-between; align-items: center; }
        .stock-name { font-weight: bold; font-size: 16px; }
        .stock-code { color: #666; font-size: 12px; background: #eee; padding: 2px 5px; border-radius: 4px; }
        .badge-buy { background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
        
        /* æ”¯æŒé¡µé¢æ ·å¼ */
        .support-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .support-panel > .card {
            max-width: 300px;
            animation: slideUp 0.3s ease;
            position: relative;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* å’–å•¡æŒ‰é’®æ ·å¼ */
        #coffee-btn {
            transition: all 0.3s ease;
        }
        
        #coffee-btn:hover {
            background: #F57C00;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            color: #666;
            cursor: pointer;
            padding: 5px;
        }
        
        .close-btn:hover {
            color: var(--danger);
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <div class="header-content">
                <div class="app-title">Bursa AIæŠ•èµ„è®¡ç®—å™¨</div>
                <div style="font-size: 11px; opacity: 0.8; margin-top:5px;">ğŸ“Š æ•°æ®å®æ—¶æ›´æ–°</div>
            </div>
        </div>

        <div class="tab-bar">
            <div class="tab active" onclick="switchTab('stocks')">AIé€‰è‚¡</div>
            <div class="tab" onclick="switchTab('calculator')">è®¡ç®—å™¨</div>
            <div class="tab" onclick="switchTab('history')">å†å²æ•°æ®</div>
        </div>
        
        <div class="content">
            <!-- AIé€‰è‚¡é¡µé¢ -->
            <div id="stocks-tab" class="tab-content active">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="font-size: 16px; color: var(--primary);">
                            <i class="fas fa-star"></i> ä»Šæ—¥AIæ¨è
                        </h3>
                        <div style="font-size: 11px; color: #999;">ç‚¹å‡»è‚¡ç¥¨å¡ç‰‡è‡ªåŠ¨å¡«å……è®¡ç®—å™¨</div>
                    </div>
                    <div id="latestStocksContainer">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- è®¡ç®—å™¨é¡µé¢ - å…¨æ–°è®¾è®¡ -->
            <div id="calculator-tab" class="tab-content">
                <div class="calculator-card">
                    <div class="section-title">
                        <i class="fas fa-chart-bar"></i> è‚¡ç¥¨ä¿¡æ¯
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">è‚¡ç¥¨ä»£ç </label>
                        <div class="input-field">
                            <input type="text" id="stockCode" placeholder="ä¾‹å¦‚: 53473N" oninput="updateCalculator()">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">è‚¡ç¥¨åç§°</label>
                        <div class="input-field">
                            <input type="text" id="stockName" placeholder="é€‰æ‹©è‚¡ç¥¨åè‡ªåŠ¨å¡«å……" readonly style="background:#f5f5f5;">
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-field">
                            <label class="input-label">ä¹°å…¥ä»· (RM)</label>
                            <input type="number" id="buyPrice" step="0.001" placeholder="0.000" oninput="updateCalculator()">
                        </div>
                        <div class="input-field">
                            <label class="input-label">ç›®æ ‡ä»· (RM)</label>
                            <input type="number" id="targetPrice" step="0.001" placeholder="0.000" oninput="updateCalculator()">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">è´­ä¹°è‚¡æ•° (å•ä½: 100è‚¡)</label>
                        <div class="input-field">
                            <input type="number" id="stockLots" value="10" min="1" oninput="updateCalculator()">
                            <span class="info-text">1 Lot = 100 è‚¡</span>
                        </div>
                    </div>
                    
                    <div class="summary-box">
                        <div class="summary-text">æ€»è‚¡æ•°</div>
                        <div class="summary-value" id="totalShares">1,000 è‚¡</div>
                        <div class="summary-text" style="margin-top:10px;">æŠ•èµ„é‡‘é¢</div>
                        <div class="summary-value" id="investmentAmount">RM 0.00</div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="section-title">
                        <i class="fas fa-calculator"></i> è´¹ç”¨è®¾ç½®ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
                    </div>
                    
                    <div class="result-card">
                        <div class="result-row">
                            <span class="result-label">äº¤æ˜“æ€»å€¼:</span>
                            <span class="result-value" id="calcTotalValue">RM 0.00</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">ä½£é‡‘ (0.1% min RM8):</span>
                            <span class="result-value" id="calcBrokerFee">RM 0.00</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">å°èŠ±ç¨:</span>
                            <span class="result-value" id="calcStampDuty">RM 0.00</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">æ¸…ç®—è´¹:</span>
                            <span class="result-value" id="calcClearingFee">RM 0.00</span>
                        </div>
                        <div class="result-row total-row">
                            <span class="result-label">å‡€æŠ•èµ„æ€»é¢:</span>
                            <span class="result-value" id="calcNetInvestment" style="color:var(--danger);">RM 0.00</span>
                        </div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div class="section-title">
                        <i class="fas fa-chart-line"></i> æŠ•èµ„å›æŠ¥åˆ†æ
                    </div>
                    
                    <div class="result-card">
                        <div class="result-row">
                            <span class="result-label">ç›®æ ‡å–å‡ºæ€»å€¼:</span>
                            <span class="result-value" id="targetTotalValue">RM 0.00</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">å–å‡ºè´¹ç”¨:</span>
                            <span class="result-value" id="sellCost">RM 0.00</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">å‡€å›é…¬:</span>
                            <span class="result-value" id="netReturn">RM 0.00</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">å›æŠ¥ç‡:</span>
                            <span class="result-value">
                                <span id="returnRate">0.00%</span>
                                <span id="returnRateBadge" class="profit-loss profit" style="margin-left:10px; display:none;">+0.00%</span>
                            </span>
                        </div>
                        <div class="result-row total-row">
                            <span class="result-label">é¢„è®¡æ€»åˆ©æ¶¦:</span>
                            <span class="result-value" id="totalProfit" style="color:var(--success);">RM 0.00</span>
                        </div>
                    </div>
                    
                    <button class="btn-calculate" onclick="calculateFullInvestment()">
                        <i class="fas fa-calculator"></i> é‡æ–°è®¡ç®—å®Œæ•´æŠ•èµ„
                    </button>
                    
                    <div class="footer-note">
                        Â© 2025 Bursa Malaysia AIåˆ†æå·¥å…· | ä½¿ç”¨çœŸå®AIæ•°æ®<br>
                        æ•°æ®æº: AIå®æ—¶é€‰è‚¡æ•°æ® ğŸ“Š<br>
                        æ”¯æŒå¼€å‘è€… <i class="fas fa-mug-hot" style="color:var(--coffee);"></i>
                    </div>
                </div>
            </div>

            <!-- å†å²æ•°æ®é¡µé¢ -->
            <div id="history-tab" class="tab-content">
                <div class="card">
                    <div style="display: flex; gap:10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <select id="historyDateSelect" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;">
                            <option value="">é€‰æ‹©æ—¥æœŸ...</option>
                        </select>
                        <button onclick="loadSelectedHistory()" style="padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer;">
                            åŠ è½½
                        </button>
                    </div>

                    <!-- æç¤ºä¿¡æ¯ -->
                    <div style="font-size:12px; color:#666; margin-bottom:10px; background:#f0f0f0; padding:5px 10px; border-radius:4px;">
                        <i class="fas fa-info-circle"></i> æ˜¾ç¤ºæœ€æ–°5ä¸ªäº¤æ˜“æ—¥æ•°æ®ï¼ˆå…±<span id="totalHistoryDays">0</span>å¤©å†å²ï¼‰
                    </div>
                    
                    <div style="font-size: 13px; color: #666; margin-bottom:15px;">
                        æ˜¾ç¤ºæ—¥æœŸ: <span id="currentDateDisplay" style="font-weight:bold;">-</span> | 
                        è‚¡ç¥¨æ•°é‡: <span id="currentStockCount" style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px;">0</span>
                    </div>

                    <div id="historyStocksContainer">
                        <p style="text-align:center; color:#999; padding:20px;">è¯·é€‰æ‹©æ—¥æœŸåŠ è½½æ•°æ®</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç°¡åŒ–ç‰ˆæ”¯æŒåŒºåŸŸ - åªæ˜¾ç¤ºMaybank QR -->
    <div id="support-section" class="support-panel">
        <div class="card">
            <button class="close-btn" onclick="hideSupportSection()">
                <i class="fas fa-times"></i>
            </button>
            
            <div style="text-align:center; padding:15px; padding-top:25px;">
                <div style="color:var(--coffee); font-size:20px; margin-bottom:10px;">
                    <i class="fas fa-mug-hot"></i> è¯·æˆ‘å–æ¯å’–å•¡
                </div>
                <div style="color:#666; font-size:14px; margin-bottom:15px;">
                    å¦‚æœè¿™ä¸ªå·¥å…·å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œæ¬¢è¿æ”¯æŒä¸€ä¸‹
                </div>
                
                <!-- Maybank QR Code é¡¯ç¤º - ä¿®æ­£è·¯å¾‘å’Œèªæ³• -->
<div style="background:#f0f0f0; padding:15px; border-radius:8px; margin:0 auto 15px; width:220px;">
    <img src="images/maybank-qr.jpg" 
     alt="Maybank QR Pay" 
     style="width:100%; max-width:280px; height:auto; border-radius:10px; display:block; margin:0 auto;"
     onerror="showQRCodeError()">
</div>
                
                <!-- QRç åŠ è½½å¤±è´¥æç¤º -->
                <div id="maybank-error" style="color:#f44336; font-size:12px; display:none; padding:10px; background:#ffeaea; border-radius:5px; margin-bottom:15px;">
                    <i class="fas fa-exclamation-circle"></i> QRç åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„
                </div>
                
                <!-- ç®€å•è¯´æ˜ -->
                <div style="background:#f5f5f5; padding:10px; border-radius:6px; font-size:13px; margin-bottom:15px;">
                    <div style="color:var(--primary); margin-bottom:5px;">
                        <i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜ï¼š
                    </div>
                    <div style="font-size:12px; color:#666;">
                        1. ä½¿ç”¨Maybank Appæ‰«æQRç <br>
                        2. è¾“å…¥æ‚¨æƒ³æ”¯æŒçš„é‡‘é¢<br>
                        3. ç¡®è®¤è½¬è´¦å³å¯
                    </div>
                </div>
                
                <!-- æ„Ÿè°¢ä¿¡æ¯ -->
                <div style="background:#e8f5e9; padding:10px; border-radius:6px; margin-top:10px;">
                    <div style="color:#2e7d32; font-size:14px;">
                        <i class="fas fa-heart"></i> æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å›ºå®šä½ç½®çš„å’–å•¡æŒ‰é’® -->
    <button id="coffee-btn" style="
        position:fixed; 
        bottom:80px; 
        right:20px; 
        z-index:999; 
        background:#FF9800; 
        color:white; 
        border:none; 
        border-radius:50%; 
        width:50px; 
        height:50px; 
        font-size:20px; 
        cursor:pointer;
        box-shadow:0 3px 10px rgba(0,0,0,0.2);
        display:flex;
        align-items:center;
        justify-content:center;">
        <i class="fas fa-mug-hot"></i>
    </button>

    <!-- æµ‹è¯•æŒ‰é’® -->
    <button class="test-button" style="
        position:fixed; 
        bottom:20px; 
        right:20px; 
        z-index:999; 
        background: var(--primary); 
        color: white; 
        border: none; 
        border-radius: 50%; 
        width: 50px; 
        height: 50px; 
        font-size: 12px; 
        cursor: pointer;" 
        onclick="testData()">
        âœ… æµ‹è¯•
    </button>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        window.allHistoryData = {};
        window.availableDates = [];

        // ==================== æ ¹æ®å½“å‰æ–‡ä»¶ä½ç½®è‡ªåŠ¨æ£€æµ‹åŸºç¡€è·¯å¾„ ====================
        function getBasePath() {
    // è·å–å½“å‰è„šæœ¬çš„è·¯å¾„
    const currentPath = window.location.pathname;
    console.log('å½“å‰è·¯å¾„:', currentPath);
    
    // æƒ…å†µ 1: ç›´æ¥åœ¨ web/ ç›®å½•ä¸‹ (docs/web/bursa.html)
    if (currentPath.includes('/myx_shop/docs/web/bursa.html')) {
        return '';
    }
    // æƒ…å†µ 2: åœ¨ docs/ ç›®å½•ä¸‹ (docs/bursa.html)
    else if (currentPath.includes('/myx_shop/docs/bursa.html')) {
        return 'web/';
    }
    // æƒ…å†µ 3: åœ¨ GitHub Pages æ ¹ç›®å½• (myx_shop/bursa.html)
    else if (currentPath.includes('/myx_shop/bursa.html')) {
        return 'web/';
    }
    // æƒ…å†µ 4: åœ¨ web/ ç›®å½•ä¸‹ (web/bursa.html) - untuk localhost
    else if (currentPath.includes('/myx_shop/web/bursa.html')) {
        return '';
    }
    // é»˜è®¤æƒ…å†µ
    else {
        return '';
    }
}
        const BASE_PATH = getBasePath();
        console.log('åŸºç¡€è·¯å¾„è®¾ç½®ä¸º:', BASE_PATH);

        // ==================== åˆå§‹åŒ–å‡½æ•° - åŠ è½½å†å²æ•°æ® ====================
        async function initApp() {
            try {
                // å…ˆå°è¯•åŠ è½½date_config.js
                await loadDateConfig();
                
                // ç„¶ååŠ è½½æœ€æ–°æ•°æ®
                await loadLatestData();
                
            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", error);
                // å¦‚æœdate_config.jså¤±è´¥ï¼Œå°è¯•ç›´æ¥æ¢æµ‹å†å²æ–‡ä»¶
                await loadHistoryFromDirectory();
            }
        }

// ==================== åŠ è½½æ—¥æœŸé…ç½® ====================
async function loadDateConfig() {
    try {
        // æ„å»ºæ­£ç¡®çš„URL
        const configUrl = BASE_PATH + 'date_config.js';
        
        console.log('å°è¯•åŠ è½½æ—¥æœŸé…ç½®:', configUrl);
        const response = await fetch(configUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        // åŠ è½½JSæ–‡ä»¶
        const script = document.createElement('script');
        script.src = configUrl;
        document.head.appendChild(script);

        // ç­‰å¾…è„šæœ¬åŠ è½½
        await new Promise(resolve => setTimeout(resolve, 200));

        console.log('âœ… æ—¥æœŸé…ç½®åŠ è½½æˆåŠŸ:', window.availableDates);
        
        // è¿‡æ»¤æ‰ä¸å­˜åœ¨çš„æ—¥æœŸæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
        if (window.availableDates) {
            // ç§»é™¤ 2026-02-15 å¦‚æœå­˜åœ¨
            window.availableDates = window.availableDates.filter(d => d.id !== '20260215');
        }
        
        // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
        initDateSelector();

    } catch (error) {
        console.warn('âš ï¸ date_config.jsåŠ è½½å¤±è´¥:', error);
        // ä½¿ç”¨å®é™…å­˜åœ¨çš„ç¡¬ç¼–ç æ—¥æœŸ
        window.availableDates = [
            {id: '20260216', display: '2026-02-16', file: '/web/history/picks_20260216.json'},
            {id: '20260213', display: '2026-02-13', file: '/web/history/picks_20260213.json'},
            {id: '20260212', display: '2026-02-12', file: '/web/history/picks_20260212.json'},
            {id: '20260211', display: '2026-02-11', file: '/web/history/picks_20260211.json'},
            {id: '20260210', display: '2026-02-10', file: '/web/history/picks_20260210.json'},
            {id: '20260209', display: '2026-02-09', file: '/web/history/picks_20260209.json'},
            {id: '20260206', display: '2026-02-06', file: '/web/history/picks_20260206.json'},
            {id: '20260205', display: '2026-02-05', file: '/web/history/picks_20260205.json'},
            {id: '20260204', display: '2026-02-04', file: '/web/history/picks_20260204.json'},
            {id: '20260202', display: '2026-02-02', file: '/web/history/picks_20260202.json'}
        ];
        
        console.log('ä½¿ç”¨ç¡¬ç¼–ç æ—¥æœŸï¼Œå…±', window.availableDates.length, 'å¤©');
        initDateSelector();
    }
}
        
        // ==================== åŠ è½½æœ€æ–°æ•°æ® ====================
        async function loadLatestData() {
            try {
                // picks_latest.json åœ¨åŒçº§ç›®å½•
                const latestUrl = BASE_PATH + 'picks_latest.json';
                console.log('å°è¯•åŠ è½½æœ€æ–°æ•°æ®:', latestUrl);
                
                const response = await fetch(latestUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('æœ€æ–°æ•°æ®:', data);
                
                // æ¸²æŸ“åˆ°é¡µé¢
                if (data && data.picks) {
                    renderStockList(data.picks, 'latestStocksContainer', true);
                    
                    // åŒæ—¶æŠŠæœ€æ–°æ•°æ®åŠ å…¥å†å²æ•°æ®å¯¹è±¡
                    window.allHistoryData = window.allHistoryData || {};
                    window.allHistoryData[data.date_id] = data;
                    
                    // æ›´æ–°å†å²å¤©æ•°ç»Ÿè®¡
                    updateHistoryStats();
                }
                
            } catch (error) {
                console.error('åŠ è½½æœ€æ–°æ•°æ®å¤±è´¥:', error);
                document.getElementById('latestStocksContainer').innerHTML = 
                    `<div style="color:red; padding:20px;">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ==================== åŠ è½½é€‰ä¸­çš„å†å²æ•°æ® ====================
        async function loadSelectedHistory() {
            console.log('å¼€å§‹åŠ è½½å†å²æ•°æ®');
            
            const select = document.getElementById('historyDateSelect');
            if (!select) {
                console.log('æ‰¾ä¸åˆ°æ—¥æœŸé€‰æ‹©å™¨');
                return;
            }
            
            const dateId = select.value;
            console.log('é€‰æ‹©çš„æ—¥æœŸ:', dateId);
            
            if (!dateId) {
                console.log('æœªé€‰æ‹©æ—¥æœŸ');
                return;
            }
            
            try {
               // æ„å»ºæ–‡ä»¶è·¯å¾„ - ä½¿ç”¨å®Œæ•´çš„é¡¹ç›®è·¯å¾„
const fileUrl = `history/picks_${dateId}.json`;
console.log('æ­£åœ¨åŠ è½½:', fileUrl);
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('historyStocksContainer').innerHTML = 
                    '<p style="text-align:center; color:#999; padding:20px;">åŠ è½½ä¸­...</p>';
                
                const response = await fetch(fileUrl);
                console.log('å“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('æ•°æ®æ¥æ”¶æˆåŠŸ, è‚¡ç¥¨æ•°é‡:', data.picks ? data.picks.length : 0);
                
                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('currentDateDisplay').textContent = data.date || dateId;
                document.getElementById('currentStockCount').textContent = data.picks ? data.picks.length : 0;
                
                if (data.picks && data.picks.length > 0) {
                    renderStockList(data.picks, 'historyStocksContainer', false);
                } else {
                    document.getElementById('historyStocksContainer').innerHTML = 
                        '<p style="text-align:center; color:#999; padding:20px;">è¯¥æ—¥æœŸæ²¡æœ‰è‚¡ç¥¨æ•°æ®</p>';
                }
                console.log('å†å²æ•°æ®åŠ è½½å®Œæˆ');
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error.message);
                document.getElementById('historyStocksContainer').innerHTML = 
                    `<p style="text-align:center; color:red; padding:20px;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // ==================== åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨ ====================
        function initDateSelector() {
            const select = document.getElementById('historyDateSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">é€‰æ‹©æ—¥æœŸ...</option>';
            
            if (!window.availableDates || window.availableDates.length === 0) {
                select.innerHTML = '<option value="">æš‚æ— å†å²æ•°æ®</option>';
                
                const container = document.getElementById('historyStocksContainer');
                if (container) {
                    container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">æš‚æ— å†å²æ•°æ®ï¼Œè¯·å…ˆåŠ è½½æœ€æ–°æ•°æ®</p>';
                }
                return;
            }
            
            // æŒ‰æ—¥æœŸå€’åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sortedDates = [...window.availableDates].sort((a, b) => b.id.localeCompare(a.id));
            
            console.log('å¯ç”¨æ—¥æœŸ:', sortedDates.map(d => d.id));
            
            // æ·»åŠ åˆ°ä¸‹æ‹‰æ¡† - æ˜¾ç¤ºæ‰€æœ‰æ—¥æœŸ
            sortedDates.forEach(dateInfo => {
                const opt = document.createElement('option');
                opt.value = dateInfo.id;
                opt.textContent = `${dateInfo.display}`;
                select.appendChild(opt);
            });
            
            // é»˜è®¤é€‰æ‹©æœ€æ–°æ—¥æœŸ
            if (sortedDates.length > 0) {
                select.value = sortedDates[0].id;
                loadSelectedHistory();
            }
        }

        // ==================== åå¤‡æ–¹æ¡ˆï¼šç›´æ¥æ¢æµ‹å†å²æ–‡ä»¶ ====================
        async function loadHistoryFromDirectory() {
            console.log('å°è¯•ç›´æ¥æ¢æµ‹å†å²æ–‡ä»¶...');
            
            const knownDates = [
                '20260216', '20260215', '20260213', '20260212',
                '20260211', '20260210', '20260209',
                '20260206', '20260205', '20260204', '20260202'
            ];
            
            window.availableDates = [];
            
            for (const dateId of knownDates) {
                try {
                    // ä½¿ç”¨æ­£ç¡®çš„ç›¸å¯¹è·¯å¾„
                    const url = `/web/history/picks_${dateId}.json`;
                    
                    console.log(`æ£€æŸ¥æ–‡ä»¶: ${url}`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 1000);
                    
                    const response = await fetch(url, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const text = await response.text();
                        if (text.trim().startsWith('{')) {
                            window.availableDates.push({
                                id: dateId,
                                display: `${dateId.slice(0,4)}-${dateId.slice(4,6)}-${dateId.slice(6,8)}`,
                                file: `/web/history/picks_${dateId}.json`
                            });
                            console.log(`âœ… å‘ç°å†å²: ${dateId}`);
                        }
                    }
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯
                    console.log(`âŒ ${dateId} ä¸å­˜åœ¨`);
                }
            }
            
            console.log(`ğŸ“Š å…±å‘ç° ${window.availableDates.length} å¤©å†å²æ•°æ®`);
            
            // å¦‚æœæ²¡æœ‰å‘ç°ä»»ä½•æ–‡ä»¶ï¼Œä½¿ç”¨ç¡¬ç¼–ç 
            if (window.availableDates.length === 0) {
                console.log('ä½¿ç”¨ç¡¬ç¼–ç æ—¥æœŸä½œä¸ºåå¤‡');
                window.availableDates = [
                    {id: '20260216', display: '2026-02-16', file: '/web/history/picks_20260216.json'},
                    {id: '20260215', display: '2026-02-15', file: '/web/history/picks_20260215.json'},
                    {id: '20260213', display: '2026-02-13', file: '/web/history/picks_20260213.json'},
                    {id: '20260212', display: '2026-02-12', file: '/web/history/picks_20260212.json'},
                    {id: '20260211', display: '2026-02-11', file: '/web/history/picks_20260211.json'}
                ];
            }
            
            initDateSelector();
        }
        
        // ==================== æ›´æ–°å†å²æ•°æ®ç»Ÿè®¡ ====================
        function updateHistoryStats() {
            const totalDays = Object.keys(window.allHistoryData || {}).length;
            const totalElem = document.getElementById('totalHistoryDays');
            if (totalElem) totalElem.textContent = totalDays;
        }

        // ==================== é€šç”¨åˆ—è¡¨æ¸²æŸ“å‡½æ•° ====================
        function renderStockList(stocks, containerId, isLatest = false) {
            const container = document.getElementById(containerId);
            
            if (!stocks || stocks.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">æš‚æ— æ•°æ®</p>';
                return;
            }
             
            let html = '';
            stocks.forEach(stock => {
                const sector = stock.sector_name || stock.sector || 'å…¶ä»–';
                const displayName = stock.name || 'æœªçŸ¥';
                const safeName = displayName.replace(/'/g, "\\'");
                const price = parseFloat(stock.current_price || stock.price || 0);

                html += `
                <div class="stock-card clickable" onclick="selectStockToCalculator('${safeName}', '${stock.code}', ${price})">
                    <div class="stock-title">
                        <span class="stock-name">${displayName}</span>
                        <span class="stock-code">${stock.code}</span>
                    </div>
                    <div style="font-size:12px; color:#666; margin-top:4px;">
                        æ¿å—: ${sector}
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:8px; align-items:center;">
                        <div style="color:var(--danger); font-weight:bold;">RM ${price.toFixed(3)}</div>
                        <div class="badge-buy">${stock.recommendation || 'ä¹°å…¥'}</div>
                    </div>`;

                if (isLatest) {
                    html += `<div style="font-size:11px; color:#999; margin-top:5px;">ç‚¹å‡»è®¡ç®—äº¤æ˜“æˆæœ¬ â†’</div>`;
                } else {
                    html += `<div style="font-size:11px; color:#999; margin-top:5px;">è¯„åˆ†: ${stock.score || 'N/A'}</div>`;
                }

                html += `</div>`;
            });
            container.innerHTML = html;
        }

        // ==================== é€‰æ‹©è‚¡ç¥¨åˆ°è®¡ç®—å™¨ ====================
        function selectStockToCalculator(name, code, price) {
            // å¡«å……è¡¨å•
            document.getElementById('stockName').value = name;
            document.getElementById('stockCode').value = code;
            document.getElementById('buyPrice').value = price.toFixed(3);
            
            // è®¾ç½®ç›®æ ‡ä»·ä¸ºä¹°å…¥ä»·çš„110%ï¼ˆé»˜è®¤å»ºè®®ï¼‰
            const targetPrice = (price * 1.1).toFixed(3);
            document.getElementById('targetPrice').value = targetPrice;
            
            // åˆ‡æ¢åˆ°è®¡ç®—å™¨æ ‡ç­¾
            switchTab('calculator');
            
            // ç«‹å³è®¡ç®—
            setTimeout(() => {
                calculateFullInvestment();
            }, 50);
        }

        // ==================== æ›´æ–°è®¡ç®—å™¨å®æ—¶æ˜¾ç¤º ====================
        function updateCalculator() {
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const lots = parseFloat(document.getElementById('stockLots').value) || 0;
            const shares = lots * 100;
            
            // æ›´æ–°æ€»è‚¡æ•°å’ŒæŠ•èµ„é‡‘é¢
            document.getElementById('totalShares').textContent = shares.toLocaleString() + ' è‚¡';
            
            const investmentValue = buyPrice * shares;
            document.getElementById('investmentAmount').textContent = 'RM ' + investmentValue.toFixed(2);
        }

        // ==================== å®Œæ•´æŠ•èµ„è®¡ç®—å‡½æ•° ====================
        function calculateFullInvestment() {
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const targetPrice = parseFloat(document.getElementById('targetPrice').value) || 0;
            const lots = parseFloat(document.getElementById('stockLots').value) || 0;
            const shares = lots * 100;
            const totalValue = buyPrice * shares;
            
            if (buyPrice <= 0 || lots <= 0) {
                resetCalculatorResults();
                return;
            }
            
            // è®¡ç®—ä¹°å…¥æˆæœ¬
            const buyCosts = calculateBuyCosts(totalValue);
            
            // è®¡ç®—å–å‡ºæƒ…å†µ
            const targetTotalValue = targetPrice * shares;
            const sellCosts = calculateSellCosts(targetTotalValue);
            
            // è®¡ç®—å›æŠ¥
            const netInvestment = totalValue + buyCosts.total;
            const netReturn = targetTotalValue - sellCosts.total;
            const totalProfit = netReturn - netInvestment;
            const returnRate = (totalProfit / netInvestment) * 100;
            
            // æ›´æ–°ä¹°å…¥è´¹ç”¨æ˜¾ç¤º
            document.getElementById('calcTotalValue').textContent = 'RM ' + totalValue.toFixed(2);
            document.getElementById('calcBrokerFee').textContent = 'RM ' + buyCosts.brokerFee.toFixed(2);
            document.getElementById('calcStampDuty').textContent = 'RM ' + buyCosts.stampDuty.toFixed(2);
            document.getElementById('calcClearingFee').textContent = 'RM ' + buyCosts.clearingFee.toFixed(2);
            document.getElementById('calcNetInvestment').textContent = 'RM ' + netInvestment.toFixed(2);
            
            // æ›´æ–°å–å‡ºå’Œå›æŠ¥æ˜¾ç¤º
            document.getElementById('targetTotalValue').textContent = 'RM ' + targetTotalValue.toFixed(2);
            document.getElementById('sellCost').textContent = 'RM ' + sellCosts.total.toFixed(2);
            document.getElementById('netReturn').textContent = 'RM ' + netReturn.toFixed(2);
            document.getElementById('totalProfit').textContent = 'RM ' + totalProfit.toFixed(2);
            
            // æ›´æ–°å›æŠ¥ç‡
            const returnRateElement = document.getElementById('returnRate');
            const returnRateBadge = document.getElementById('returnRateBadge');
            returnRateElement.textContent = returnRate.toFixed(2) + '%';
            
            if (returnRate > 0) {
                returnRateElement.style.color = 'var(--success)';
                returnRateBadge.className = 'profit-loss profit';
                returnRateBadge.textContent = '+' + returnRate.toFixed(2) + '%';
                returnRateBadge.style.display = 'inline-block';
            } else if (returnRate < 0) {
                returnRateElement.style.color = 'var(--danger)';
                returnRateBadge.className = 'profit-loss loss';
                returnRateBadge.textContent = returnRate.toFixed(2) + '%';
                returnRateBadge.style.display = 'inline-block';
            } else {
                returnRateElement.style.color = '#666';
                returnRateBadge.style.display = 'none';
            }
        }
        
        // ==================== è®¡ç®—ä¹°å…¥æˆæœ¬ ====================
        function calculateBuyCosts(totalValue) {
            // ä½£é‡‘ (0.1%, æœ€ä½ RM8)
            let brokerFee = Math.max(8, totalValue * 0.001);
            // å°èŠ±ç¨ (æ¯ RM1000 æ”¶ RM1.50, æœ€é«˜ RM1000)
            let stampDuty = Math.min(1000, Math.ceil(totalValue / 1000) * 1.5);
            // æ¸…ç®—è´¹ (0.03%)
            let clearingFee = totalValue * 0.0003;
            
            return {
                brokerFee: brokerFee,
                stampDuty: stampDuty,
                clearingFee: clearingFee,
                total: brokerFee + stampDuty + clearingFee
            };
        }
        
        // ==================== è®¡ç®—å–å‡ºæˆæœ¬ ====================
        function calculateSellCosts(totalValue) {
            const costs = calculateBuyCosts(totalValue);
            return {
                total: costs.total
            };
        }
        
        // ==================== é‡ç½®è®¡ç®—å™¨ç»“æœ ====================
        function resetCalculatorResults() {
            const zeroValue = 'RM 0.00';
            document.getElementById('calcTotalValue').textContent = zeroValue;
            document.getElementById('calcBrokerFee').textContent = zeroValue;
            document.getElementById('calcStampDuty').textContent = zeroValue;
            document.getElementById('calcClearingFee').textContent = zeroValue;
            document.getElementById('calcNetInvestment').textContent = zeroValue;
            document.getElementById('targetTotalValue').textContent = zeroValue;
            document.getElementById('sellCost').textContent = zeroValue;
            document.getElementById('netReturn').textContent = zeroValue;
            document.getElementById('totalProfit').textContent = zeroValue;
            document.getElementById('returnRate').textContent = '0.00%';
            document.getElementById('returnRateBadge').style.display = 'none';
        }

        // ==================== æ ‡ç­¾åˆ‡æ¢ ====================
        function switchTab(tabId) {
            // ç§»é™¤æ‰€æœ‰å…§å®¹çš„ active
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // é¡¯ç¤ºç›®æ¨™å…§å®¹
            document.getElementById(tabId + '-tab').classList.add('active');
            
            // é«˜äº®å°æ‡‰æ¨™ç±¤
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.textContent.includes('AIé€‰è‚¡') && tabId === 'stocks') tab.classList.add('active');
                if (tab.textContent.includes('è®¡ç®—å™¨') && tabId === 'calculator') tab.classList.add('active');
                if (tab.textContent.includes('å†å²æ•°æ®') && tabId === 'history') tab.classList.add('active');
            });
        }

        // ==================== æ”¯æŒåŠŸèƒ½ ====================
        function showSupportSection() {
            document.getElementById('support-section').style.display = 'flex';
        }
        
        function hideSupportSection() {
            document.getElementById('support-section').style.display = 'none';
        }
        
        function showQRCodeError() {
            document.getElementById('maybank-error').style.display = 'block';
        }

        // ==================== æµ‹è¯•å‡½æ•° ====================
        function testData() {
            if(window.allHistoryData && Object.keys(window.allHistoryData).length > 0) {
                const count = Object.keys(window.allHistoryData).length;
                const latestDate = Object.keys(window.allHistoryData).sort().reverse()[0];
                
                // æµ‹è¯•è®¡ç®—å™¨åŠŸèƒ½
                document.getElementById('buyPrice').value = 1.500;
                document.getElementById('targetPrice').value = 1.650;
                document.getElementById('stockLots').value = 20;
                calculateFullInvestment();
                
                alert("âœ… æ•°æ®æºåŒ¹é…æˆåŠŸï¼\n" + 
                      "å·²åŠ è½½å†å²å¤©æ•°: " + count + "å¤©\n" +
                      "æœ€æ–°æ—¥æœŸ: " + latestDate + "\n" +
                      "å¯ç”¨å†å²æ—¥æœŸ: " + window.availableDates.length + "å¤©\n" +
                      "åŸºç¡€è·¯å¾„: " + BASE_PATH);
            } else {
                alert("âŒ æ— æ³•åŠ è½½AIé€‰è‚¡æ•°æ®ï¼Œè¯·ç¨åé‡è¯•ã€‚");
            }
        }

// ==================== åˆå§‹åŒ–å‡½æ•° - åŠ è½½å†å²æ•°æ® ====================
async function initApp() {
    try {
        // å…ˆå°è¯•åŠ è½½date_config.js
        await loadDateConfig();
        
        // ç„¶ååŠ è½½æœ€æ–°æ•°æ®
        await loadLatestData();
        
        // âœ… å¼ºåˆ¶åŠ è½½å†å²æ–‡ä»¶åˆ—è¡¨
        await loadHistoryFromDirectory();
        
    } catch (error) {
        console.error("åˆå§‹åŒ–å¤±è´¥:", error);
        // å¦‚æœdate_config.jså¤±è´¥ï¼Œå°è¯•ç›´æ¥æ¢æµ‹å†å²æ–‡ä»¶
        await loadHistoryFromDirectory();
    }
}

// ==================== äº‹ä»¶ç»‘å®š ====================
document.addEventListener('DOMContentLoaded', function() {
    initApp();
    
    // åˆå§‹åŒ–å’–å•¡æŒ‰é’®äº‹ä»¶
    document.getElementById('coffee-btn').addEventListener('click', showSupportSection);
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­æ”¯æŒé¢æ¿
    document.getElementById('support-section').addEventListener('click', function(e) {
        if (e.target === this) {
            hideSupportSection();
        }
    });
    
    // åˆå§‹åŒ–è®¡ç®—å™¨
    updateCalculator();
});
    </script>
</body>
</html>
